{% extends "base.html" %}

{% block title %}
  コース管理 | {{ display_name }}
{% endblock %}

{% block content %}

<div class="container">
  <h1>コース管理</h1>

  {% if success %}
    <div class="alert alert-success">{{ success }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- コースカテゴリ管理ボタン -->
  <div style="margin-bottom: 20px;">
    <button type="button" class="btn btn-info" onclick="openModal('categoryModal')">
      コースカテゴリ管理
    </button>
  </div>

  <div class="page-layout">
    <!-- コース登録フォーム -->
    <div class="form-div-left">
      <h2>コース登録フォーム</h2>
      <form method="post" action="{{ url_for('main_routes.register_course', store=store) }}">
        <div class="form-group">
          <label for="name" class="form-label">コース名 (必須):</label>
          <input type="text" class="form-control" id="name" name="name" required placeholder="例）プレミアムコース">
        </div>
        <div class="form-group">
          <label for="category_id" class="form-label">コースカテゴリ (必須):</label>
          <select class="form-control" id="category_id" name="category_id" required>
            <option value="">カテゴリを選択してください</option>
            {% for category in categories %}
              <option value="{{ category.category_id }}">{{ category.category_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="time_minutes" class="form-label">時間（分） (必須):</label>
          <input type="number" class="form-control" id="time_minutes" name="time_minutes" required placeholder="例）90" min="1">
        </div>
        <div class="form-group">
          <label for="price" class="form-label">料金（円） (必須):</label>
          <input type="number" class="form-control" id="price" name="price" required placeholder="例）18000" min="0">
        </div>
        <div class="form-group">
          <label for="cast_back_amount" class="form-label">バック金額（円） (必須):</label>
          <input type="number" class="form-control" id="cast_back_amount" name="cast_back_amount" required placeholder="例）7500" min="0">
        </div>
        <button type="submit" class="btn-register">登録</button>
      </form>
    </div>

    <!-- コース一覧 -->
    <div class="table-div-right">
      <h2>コース一覧</h2>
      <div class="table-responsive">
        {% if courses %}
          <table class="table table-striped">
            <thead>
                <tr>
                    <th>並び順</th>
                    <th>コース名</th>
                    <th>カテゴリ</th>
                    <th>時間</th>
                    <th>料金</th>
                    <th>バック金額</th>
                    <th>状態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for course in courses %}
                <tr>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <a href="{{ url_for('main_routes.move_course_up', store=store, course_id=course.course_id) }}" class="btn-yazirusi">↑</a>
                            <a href="{{ url_for('main_routes.move_course_down', store=store, course_id=course.course_id) }}" class="btn-yazirusi">↓</a>
                        </div>
                    </td>
                    <td>{{ course.name }}</td>
                    <td>{{ course.category_name or 'カテゴリなし' }}</td>
                    <td>{{ course.time_minutes }}分</td>
                    <td>{{ "{:,}".format(course.price) if course.price else '未設定' }}円</td>
                    <td>{{ "{:,}".format(course.cast_back_amount) if course.cast_back_amount else '未設定' }}円</td>
                    <td>
                        {% if course.is_active %}
                            <span class="badge bg-success">有効</span>
                        {% else %}
                            <span class="badge bg-secondary">無効</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('main_routes.edit_course', store=store, course_id=course.course_id) }}" class="btn btn-edit">編集</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
          <p>登録されているコースはありません。</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- コースカテゴリ管理モーダル -->
<div class="modal" id="categoryModal">
  <div class="modal-dialog modal-dialog-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">コースカテゴリ管理</h5>
        <button type="button" class="btn-close" onclick="closeModal('categoryModal')"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-left">
            <h6>新しいカテゴリ追加</h6>
            <form method="post" action="{{ url_for('main_routes.register_course', store=store) }}">
              <input type="hidden" name="action" value="add_category">
              <div class="input-group">
                <input type="text" class="form-control" name="name" placeholder="カテゴリ名" required>
                <button type="submit" class="btn btn-success">追加</button>
              </div>
            </form>
          </div>
          <div class="col-right">
            <h6>登録済みカテゴリ</h6>
            {% if categories %}
              <ul class="list-group">
                {% for category in categories %}
                  <li class="list-group-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="category-name-{{ category.category_id }}">{{ category.category_name }}</span>
                    <input type="text" class="form-control hidden" id="category-edit-{{ category.category_id }}" value="{{ category.category_name }}">
                    <div>
                      <button class="btn btn-edit" onclick="editCategory({{ category.category_id }})">編集</button>
                      <form method="post" action="{{ url_for('main_routes.register_course', store=store) }}" style="display: none;" id="category-form-{{ category.category_id }}">
                        <input type="hidden" name="action" value="edit_category">
                        <input type="hidden" name="category_id" value="{{ category.category_id }}">
                        <input type="hidden" name="name" id="category-name-input-{{ category.category_id }}">
                      </form>
                      <button class="btn btn-success hidden" onclick="saveCategory({{ category.category_id }})">保存</button>
                      <button class="btn btn-secondary hidden" onclick="cancelEditCategory({{ category.category_id }})">キャンセル</button>
                      <form method="post" action="{{ url_for('main_routes.register_course', store=store) }}" style="display: inline;">
                        <input type="hidden" name="action" value="delete_category">
                        <input type="hidden" name="category_id" value="{{ category.category_id }}">
                        <button type="submit" class="btn btn-delete" onclick="return confirm('本当にこのカテゴリを削除しますか？')">削除</button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p>登録されているカテゴリはありません。</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// モーダル制御
function openModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// 共通のユーティリティ関数
function toggleEditMode(type, id, isEditing) {
  const nameElement = document.getElementById(`${type}-name-${id}`);
  const editElement = document.getElementById(`${type}-edit-${id}`);
  const editButton = document.querySelector(`[onclick="edit${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);
  const saveButton = document.querySelector(`[onclick="save${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);
  const cancelButton = document.querySelector(`[onclick="cancelEdit${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);

  if (isEditing) {
      nameElement.classList.add('hidden');
      editElement.classList.remove('hidden');
      editButton.classList.add('hidden');
      saveButton.classList.remove('hidden');
      cancelButton.classList.remove('hidden');
  } else {
      nameElement.classList.remove('hidden');
      editElement.classList.add('hidden');
      editButton.classList.remove('hidden');
      saveButton.classList.add('hidden');
      cancelButton.classList.add('hidden');
  }
}

// カテゴリ編集機能
function editCategory(id) {
    toggleEditMode('category', id, true);
}

function saveCategory(id) {
    const newName = document.getElementById(`category-edit-${id}`).value.trim();
    if (!newName) {
        alert('カテゴリ名を入力してください。');
        return;
    }
    
    document.getElementById(`category-name-input-${id}`).value = newName;
    document.getElementById(`category-form-${id}`).submit();
}

function cancelEditCategory(id) {
    toggleEditMode('category', id, false);
}
</script>

{% endblock %}