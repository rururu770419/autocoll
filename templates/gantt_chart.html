{% extends "base.html" %}

{% block title %}ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ - {{ date_display }}{% endblock %}

{% block content %}
<!-- â˜…ã“ã“ã§CSSã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã®å¤–ï¼‰â˜… -->
<link rel="stylesheet" href="/static/css/gantt_chart.css">

<div class="gantt-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="gantt-header">
    <h1 class="gantt-title">ğŸ“… ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
    
    <!-- æ—¥ä»˜ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="gantt-controls">
      <a href="{{ url_for('gantt.gantt_chart', store=store, date=prev_date) }}" class="gantt-nav-btn">
        â† å‰æ—¥
      </a>
      <div class="gantt-date-display">
        {{ date_display }}
      </div>
      <a href="{{ url_for('gantt.gantt_chart', store=store, date=next_date) }}" class="gantt-nav-btn">
        ç¿Œæ—¥ â†’
      </a>
    </div>
  </div>

  <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæœ¬ä½“ -->
  <div class="gantt-body">
    <div class="gantt-wrapper">
      <!-- å·¦å´ï¼šã‚­ãƒ£ã‚¹ãƒˆåä¸€è¦§ï¼ˆå›ºå®šï¼‰ -->
      <div class="gantt-cast-column">
        <div class="gantt-cast-header">ã‚­ãƒ£ã‚¹ãƒˆ</div>
        {% for cast in gantt_data.casts %}
        <div class="gantt-cast-cell">
          <span class="gantt-cast-name">{{ cast.cast_name }}</span>
          <span class="gantt-cast-time">{{ cast.start_time }}ï½{{ cast.end_time }}</span>
        </div>
        {% endfor %}
        
        {% if gantt_data.casts|length == 0 %}
        <div class="gantt-no-data">
          æœ¬æ—¥ã®å‡ºå‹¤ã‚­ãƒ£ã‚¹ãƒˆã¯ã„ã¾ã›ã‚“
        </div>
        {% endif %}
      </div>

      <!-- å³å´ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ -->
      <div class="gantt-timeline-wrapper">
        <!-- æ™‚é–“è»¸ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1æ™‚é–“ã”ã¨ã«è¡¨ç¤ºï¼‰ -->
        <div class="gantt-timeline-header">
          {% for slot in time_slots %}
          {% if slot.value.endswith(':00') %}
          <div class="gantt-time-cell" style="width: 180px;">{{ slot.label }}</div>
          {% endif %}
          {% endfor %}
        </div>

        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœ¬ä½“ -->
        <div class="gantt-timeline-body">
          {% for cast in gantt_data.casts %}
          <div class="gantt-timeline-row" data-cast-id="{{ cast.cast_id }}">
            <!-- å‡ºå‹¤æ™‚é–“ã®èƒŒæ™¯ -->
            <div class="gantt-work-bg" 
                 data-start="{{ cast.start_time }}"
                 data-end="{{ cast.end_time }}">
            </div>
            
            <!-- äºˆç´„ãƒãƒ¼ -->
            {% for reservation in cast.reservations %}
            <div class="gantt-reservation-bar" 
                 data-start="{{ reservation.start_time }}"
                 data-end="{{ reservation.end_time }}"
                 data-reservation-id="{{ reservation.reservation_id }}"
                 onclick="showReservationDetail({{ reservation.reservation_id }})">
              <div class="gantt-reservation-content">
                <div class="gantt-reservation-time">{{ reservation.start_time }}ï½{{ reservation.end_time }}</div>
                <div class="gantt-reservation-customer">{{ reservation.customer_name }}æ§˜</div>
                {% if reservation.hotel_name %}
                <div class="gantt-reservation-hotel">
                  {{ reservation.hotel_name }}
                  {% if reservation.room_number %}[{{ reservation.room_number }}å·å®¤]{% endif %}
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
            
            <!-- æ™‚é–“ã‚°ãƒªãƒƒãƒ‰ -->
            {% for slot in time_slots %}
            <div class="gantt-time-grid"></div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- äºˆç´„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå°†æ¥å®Ÿè£…ï¼‰ -->
<div id="reservationModal" class="gantt-modal" style="display: none;">
  <div class="gantt-modal-overlay" onclick="closeReservationModal()"></div>
  <div class="gantt-modal-content">
    <h2>äºˆç´„è©³ç´°</h2>
    <div id="reservationDetail"></div>
    <button onclick="closeReservationModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gantt_chart.js') }}"></script>
<script>
// æ™‚é–“ã‹ã‚‰ä½ç½®ï¼ˆ%ï¼‰ã‚’è¨ˆç®—
function calculatePosition(time, timeSlots) {
  if (!time) return 0;
  
  // time ã¯ "10:00" å½¢å¼
  const targetMinutes = timeToMinutes(time);
  const startMinutes = timeToMinutes('{{ time_slots[0].value }}');
  const endMinutes = timeToMinutes('{{ time_slots[-1].value }}');
  const totalMinutes = endMinutes - startMinutes;
  
  return ((targetMinutes - startMinutes) / totalMinutes) * 100;
}

// æ™‚é–“ã‹ã‚‰å¹…ï¼ˆ%ï¼‰ã‚’è¨ˆç®—
function calculateDuration(startTime, endTime, timeSlots) {
  if (!startTime || !endTime) return 0;
  
  const startMinutes = timeToMinutes(startTime);
  const endMinutes = timeToMinutes(endTime);
  const duration = endMinutes - startMinutes;
  
  const totalStartMinutes = timeToMinutes('{{ time_slots[0].value }}');
  const totalEndMinutes = timeToMinutes('{{ time_slots[-1].value }}');
  const totalMinutes = totalEndMinutes - totalStartMinutes;
  
  return (duration / totalMinutes) * 100;
}

// æ™‚åˆ»ã‚’åˆ†ã«å¤‰æ›
function timeToMinutes(time) {
  const [hours, minutes] = time.split(':').map(Number);
  return hours * 60 + minutes;
}

// äºˆç´„è©³ç´°è¡¨ç¤º
function showReservationDetail(reservationId) {
  alert(`äºˆç´„ID: ${reservationId} ã®è©³ç´°è¡¨ç¤ºï¼ˆæœªå®Ÿè£…ï¼‰`);
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeReservationModal() {
  document.getElementById('reservationModal').style.display = 'none';
}
</script>
{% endblock %}