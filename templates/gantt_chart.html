{% extends "base.html" %}

{% block title %}ガントチャート - {{ date_display }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/gantt_chart.css">

<div class="gantt-container">
  <!-- ヘッダー -->
  <div class="gantt-header">
    <h1 class="gantt-title">📅 タイムスケジュール</h1>
    
    <!-- 日付ナビゲーション -->
    <div class="gantt-controls">
      <a href="{{ url_for('gantt.gantt_chart', store=store, date=prev_date) }}" class="gantt-nav-btn">
        ← 前日
      </a>
      <div class="gantt-date-display">
        {{ date_display }}
      </div>
      <a href="{{ url_for('gantt.gantt_chart', store=store, date=next_date) }}" class="gantt-nav-btn">
        翌日 →
      </a>
    </div>
  </div>

  <!-- ガントチャート本体 -->
  <div class="gantt-body">
    <div class="gantt-wrapper">
      <!-- 左側：キャスト名一覧（固定） -->
      <div class="gantt-cast-column">
        <div class="gantt-cast-header">キャスト</div>
        {% for cast in gantt_data.casts %}
        <div class="gantt-cast-cell">
          <span class="gantt-cast-name">{{ cast.cast_name }}</span>
          <span class="gantt-cast-time">{{ cast.start_time }}～{{ cast.end_time }}</span>
        </div>
        {% endfor %}
        
        {% if gantt_data.casts|length == 0 %}
        <div class="gantt-no-data">
          本日の出勤キャストはいません
        </div>
        {% endif %}
      </div>

      <!-- 右側：タイムライン（スクロール可能） -->
      <div class="gantt-timeline-wrapper">
        <!-- 時間軸ヘッダー（1時間ごとに表示） -->
        <div class="gantt-timeline-header">
          {% for slot in time_slots %}
          {% if slot.value.endswith(':00') %}
          <div class="gantt-time-cell" style="width: 180px;">{{ slot.label }}</div>
          {% endif %}
          {% endfor %}
        </div>

        <!-- タイムライン本体 -->
        <div class="gantt-timeline-body">
          {% for cast in gantt_data.casts %}
          <div class="gantt-timeline-row" data-cast-id="{{ cast.cast_id }}">
            <!-- 出勤時間の背景 -->
            <div class="gantt-work-bg" 
                 data-start="{{ cast.start_time }}"
                 data-end="{{ cast.end_time }}">
            </div>
            
            <!-- 予約バー -->
            {% for reservation in cast.reservations %}
            <div class="gantt-reservation-bar" 
                 data-start="{{ reservation.start_time }}"
                 data-end="{{ reservation.end_time }}"
                 data-reservation-id="{{ reservation.reservation_id }}">
              <div class="gantt-reservation-content">
                <!-- 編集ボタン + お客様名 -->
                <div class="gantt-reservation-header">
                  <a href="{{ url_for('reservation.edit_reservation', store=store, reservation_id=reservation.reservation_id) }}" 
                     class="gantt-edit-btn"
                     onclick="event.stopPropagation()">
                    編集
                  </a>
                  <span class="gantt-reservation-customer">{{ reservation.customer_name }}様</span>
                </div>
                
                <!-- 予約時間 -->
                <div class="gantt-reservation-time">{{ reservation.start_time }}～{{ reservation.end_time }}</div>
                
                <!-- ホテル + 部屋番号入力 -->
                {% if reservation.hotel_name %}
                <div class="gantt-reservation-hotel-row">
                  <span class="gantt-hotel-name">{{ reservation.hotel_name }}</span>
                  <input type="text" 
                         class="gantt-room-number-input" 
                         value="{{ reservation.room_number or '' }}"
                         maxlength="3"
                         placeholder="___"
                         data-reservation-id="{{ reservation.reservation_id }}"
                         onclick="event.stopPropagation()"
                         onchange="updateRoomNumber(this)"
                         title="部屋番号を入力">
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
            
            <!-- 時間グリッド -->
            {% for slot in time_slots %}
            <div class="gantt-time-grid"></div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gantt_chart.js') }}"></script>
{% endblock %}