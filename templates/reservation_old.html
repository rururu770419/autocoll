{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/reservation.css') }}">
{% endblock %}

{% block title %}予約登録 | {{ display_name }}{% endblock %}

{% block content %}
<div class="reservation-container">
    <!-- ========== 第1列：顧客情報表示エリア ========== -->
    <div class="customer-info-area">
        <div class="customer-info-card">
            <!-- 顧客ヘッダー -->
            <div class="customer-header">
                <p class="customer-number">顧客番号: <span id="customer_number_display">{{ customer.get('customer_number', '---') }}</span></p>
                <h2 class="customer-name" id="customer_name_display">{{ customer.get('name', '名前未登録') }} 様</h2>
                <p class="customer-phone" id="customer_phone_display">{{ customer.get('phone', '未登録') }}</p>
            </div>

            <!-- 統計情報 -->
            <div class="customer-stats">
                <div class="stat-item">
                    <label>来店回数</label>
                    <div class="stat-value"><span id="visit_count_display">{{ customer.get('visit_count', 0) }}</span> <span class="stat-unit">times</span></div>
                </div>

                <div class="stat-item">
                    <label>現在のPT</label>
                    <div class="stat-value" id="current_pt_display">{{ "{:,}".format(customer.get('current_points', 0) or 0) }} <span class="stat-unit">PT</span></div>
                </div>

                <div class="stat-item">
                    <label>最終来店日時</label>
                    <div class="stat-value" id="last_visit_display">
                        {% if customer.get('last_visit_date') %}
                            {{ customer.get('last_visit_date').strftime('%Y年%m月%d日') }}
                        {% else %}
                            未来店
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 詳細ボタン -->
            <button type="button" class="customer-detail-btn" onclick="goToCustomerDetail()">
                詳細
            </button>
        </div>

        <!-- 顧客検索/変更ボタン -->
        <button type="button" class="customer-search-btn" onclick="searchCustomer()">
            顧客を検索・変更
        </button>
    </div>

    <!-- ========== 第2-4列：予約入力フォームエリア ========== -->
    <div class="reservation-form-area">
        <form id="reservation_form">
            <!-- 隠しフィールド -->
            <input type="hidden" id="customer_id" name="customer_id" value="{{ customer.get('customer_id', '') }}">

            <!-- ========== 列2 ========== -->
            <div class="form-column">
                <!-- 成約種別 -->
                <div class="form-group">
                    <label>成約種別</label>
                    <select id="contract_type" name="contract_type" class="form-select" onchange="toggleCancellation()">
                        <option value="contract" selected>成約</option>
                        <option value="cancel">キャンセル</option>
                    </select>
                </div>

                <!-- キャスト -->
                <div class="form-group">
                    <label>キャスト</label>
                    <select id="cast_id" name="cast_id" class="form-select">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- オプション（複数選択） -->
                <div class="form-group">
                    <label>オプション</label>
                    <select id="options" name="options" class="form-select" multiple size="3" onchange="calculateTotal()">
                    </select>
                </div>

                <!-- 交通費 -->
                <div class="form-group">
                    <label>交通費</label>
                    <select id="transportation_fee" name="transportation_fee" class="form-select" onchange="calculateTotal()">
                        <option value="0">なし</option>
                    </select>
                </div>
            </div>

            <!-- ========== 列3 ========== -->
            <div class="form-column">
                <!-- キャンセル理由 -->
                <div class="form-group">
                    <label>キャンセル理由</label>
                    <select id="cancellation_reason" name="cancellation_reason" class="form-select" disabled>
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- 指名 -->
                <div class="form-group">
                    <label>指名種類</label>
                    <select id="nomination_type" name="nomination_type" class="form-select" onchange="calculateTotal()">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- 延長 -->
                <div class="form-group">
                    <label>延長</label>
                    <select id="extension" name="extension" class="form-select" onchange="calculateTotal()">
                        <option value="">なし</option>
                    </select>
                </div>

                <!-- ホテル名 -->
                <div class="form-group">
                    <label>ホテル名</label>
                    <select id="hotel_id" name="hotel_id" class="form-select">
                        <option value="">選択してください</option>
                    </select>
                </div>
            </div>

            <!-- ========== 列4 ========== -->
            <div class="form-column">
                <!-- 予約方法 -->
                <div class="form-group">
                    <label>予約方法</label>
                    <select id="reservation_method" name="reservation_method" class="form-select">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- コース -->
                <div class="form-group">
                    <label>コース</label>
                    <select id="course_id" name="course_id" class="form-select" onchange="calculateTotal()">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- 待ち合わせ場所 -->
                <div class="form-group">
                    <label>待ち合わせ場所</label>
                    <select id="meeting_place" name="meeting_place" class="form-select">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- 部屋番号 -->
                <div class="form-group">
                    <label>部屋番号</label>
                    <input type="text" id="room_number" name="room_number" class="form-input" placeholder="部屋番号を入力">
                </div>

                <!-- 支払い方法 -->
                <div class="form-group">
                    <label>支払い方法</label>
                    <select id="payment_method" name="payment_method" class="form-select">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <!-- 担当スタッフ -->
                <div class="form-group">
                    <label>担当スタッフ</label>
                    <select id="staff_id" name="staff_id" class="form-select">
                    </select>
                </div>
            </div>

            <!-- ========== 料金総額（列2-4全幅） ========== -->
            <div class="form-full-width">
                <div class="form-group">
                    <label>料金総額</label>
                    <input type="text" id="total_amount" name="total_amount" class="form-input" readonly value="0円">
                </div>
            </div>

            <!-- ========== PT追加・PT消費（列2-4全幅） ========== -->
            <div class="form-full-width">
                <div class="pt-row">
                    <div class="pt-input-group">
                        <label>PT追加</label>
                        <input type="number" id="pt_add" name="pt_add" class="pt-input" placeholder="0" min="0" oninput="calculatePT()">
                        <span class="pt-unit">PT</span>
                    </div>

                    <div class="pt-input-group">
                        <label>PT消費</label>
                        <input type="number" id="pt_consume" name="pt_consume" class="pt-input" placeholder="0" min="0" oninput="calculatePT()">
                        <span class="pt-unit">PT</span>
                    </div>

                    <div class="pt-result">
                        <label>残PT</label>
                        <span id="remaining_pt" class="pt-value">1,500</span>
                        <span class="pt-unit">PT</span>
                    </div>
                </div>
            </div>

            <!-- ========== 登録コメント（列2-4全幅） ========== -->
            <div class="form-full-width">
                <div class="form-group">
                    <label>登録コメント</label>
                    <textarea id="comment" name="comment" class="form-textarea" rows="3" placeholder="予約に関するコメントを入力"></textarea>
                </div>
            </div>

            <!-- ========== 送信ボタン（列2-4全幅） ========== -->
            <div class="form-full-width form-actions">
                <button type="button" class="btn-reset" onclick="resetForm()">リセット</button>
                <button type="submit" class="btn-submit">予約登録</button>
            </div>
        </form>
    </div>
</div>

<script>
// 顧客の現在のPTを初期値として設定
window.addEventListener('DOMContentLoaded', function() {
    currentCustomerPT = {{ customer.get('current_points', 0) or 0 }};
    calculatePT(); // PT表示を初期化
});
</script>
<script src="{{ url_for('static', filename='js/reservation.js') }}"></script>
{% endblock %}
