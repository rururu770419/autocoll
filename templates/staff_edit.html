{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_management.css') }}">
{% endblock %}

{% block title %}
  {% if mode == 'new' %}æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²{% else %}{{ user.name }}ã•ã‚“ã®ç·¨é›†{% endif %} | {{ display_name }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_management.css') }}">

<div class="container">
  <h1>
    {% if mode == 'new' %}
      æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²
    {% else %}
      {{ user.name }}ã•ã‚“ã®ç·¨é›†
    {% endif %}
  </h1>

  {% if success %}
    <div class="alert alert-success">{{ success }}</div>
  {% endif %}
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <div class="staff-edit-back-section">
    <a href="{{ url_for('main_routes.register_staff', store=store) }}" class="btn btn-secondary">â† ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>

  <div class="page-layout">
    <!-- åŸºæœ¬æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="form-section">
      <h2>{% if mode == 'new' %}åŸºæœ¬æƒ…å ±ç™»éŒ²{% else %}åŸºæœ¬æƒ…å ±ç·¨é›†{% endif %}</h2>
      
      <form method="post" action="{{ url_for('main_routes.save_staff', store=store) }}" class="staff-edit-form">
        {% if mode == 'edit' and user %}
          <input type="hidden" name="user_id" value="{{ user.id }}">
        {% endif %}
        
        <!-- åŸºæœ¬æƒ…å ± -->
        <div class="form-group">
          <label for="name" class="form-label">åå‰ <span class="required-mark">*</span></label>
          <input type="text" class="form-control" id="name" name="name" 
                 value="{{ user.name if user else '' }}" required placeholder="ä¾‹ï¼‰åº—é•·">
        </div>
        
        <div class="form-group">
          <label for="color" class="form-label">ã‚«ãƒ©ãƒ¼:</label>
          <div class="color-picker-group">
            <input type="color" class="form-control color-input" id="color" name="color" 
                   value="{{ user.color if user and user.color else '#FFE5E5' }}" required>
            <span id="color-preview" class="color-preview">é¸æŠã—ãŸè‰²</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="login_id" class="form-label">ãƒ­ã‚°ã‚¤ãƒ³ID <span class="required-mark">*</span></label>
          <input type="text" class="form-control" id="login_id" name="login_id" 
                 value="{{ user.login_id if user else '' }}" required placeholder="åŠè§’è‹±æ•°å­—" autocomplete="new-username">
        </div>
        
        <div class="form-group">
          <label for="password" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="required-mark">*</span></label>
          <input type="password" class="form-control" id="password" name="password" 
                 value="{{ user.password if user else '' }}" required placeholder="åŠè§’è‹±æ•°å­—" autocomplete="new-password">
        </div>
        
        <div class="form-group">
          <label class="form-label">æ¨©é™ <span class="required-mark">*</span></label>
          <div class="role-selection-group">
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="role_staff" name="role" value="ã‚¹ã‚¿ãƒƒãƒ•"
                     {% if user and user.role == 'ã‚¹ã‚¿ãƒƒãƒ•' %}checked{% endif %}>
              <label class="form-check-label" for="role_staff">ã‚¹ã‚¿ãƒƒãƒ•</label>
            </div>
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" id="role_driver" name="role" value="ãƒ‰ãƒ©ã‚¤ãƒãƒ¼"
                     {% if not user or user.role == 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼' %}checked{% endif %} required>
              <label class="form-check-label" for="role_driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</label>
            </div>
          </div>
        </div>
        
        <!-- LINEè¨­å®š -->
        <div class="form-group">
          <label for="line_id" class="form-label">LINE User ID</label>
          <input type="text" class="form-control" id="line_id" name="line_id" 
                 value="{{ user.line_id if user and user.line_id else '' }}" 
                 placeholder="U1a2b3c4d5e6f7g8h9... (Uã§å§‹ã¾ã‚‹æ–‡å­—åˆ—)">
          <small class="line-id-help">ç®¡ç†è€…ãŒLINEç®¡ç†ç”»é¢ã§ç¢ºèªã—ãŸUser IDã‚’å…¥åŠ›</small>
        </div>
        
        <div class="form-group">
          <label for="notification_minutes_before" class="form-label">é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
          <select class="form-control" id="notification_minutes_before" name="notification_minutes_before">
            <option value="5" {% if user and user.notification_minutes_before == 5 %}selected{% endif %}>5åˆ†å‰</option>
            <option value="10" {% if not user or user.notification_minutes_before == 10 %}selected{% endif %}>10åˆ†å‰</option>
            <option value="15" {% if user and user.notification_minutes_before == 15 %}selected{% endif %}>15åˆ†å‰</option>
            <option value="20" {% if user and user.notification_minutes_before == 20 %}selected{% endif %}>20åˆ†å‰</option>
            <option value="30" {% if user and user.notification_minutes_before == 30 %}selected{% endif %}>30åˆ†å‰</option>
          </select>
        </div>
        
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="line_notification_enabled" name="line_notification_enabled"
                   {% if not user or user.line_notification_enabled %}checked{% endif %}>
            <label class="form-check-label" for="line_notification_enabled">
              LINEé€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            </label>
          </div>
        </div>
        
        <button type="submit" class="btn-register">
          {% if mode == 'new' %}ç™»éŒ²{% else %}æ›´æ–°{% endif %}
        </button>
      </form>
      
      <!-- å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®å¤–ã«é…ç½® -->
      {% if mode == 'edit' and user %}
      <form method="post" action="{{ url_for('main_routes.delete_staff_by_id', store=store, user_id=user.id) }}" class="staff-delete-form-separate" onsubmit="return confirm('æœ¬å½“ã«{{ user.name }}ã•ã‚“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€‚');">
        <button type="submit" class="btn btn-delete">å‰Šé™¤</button>
      </form>
      {% endif %}
    </div>

    <!-- LINEé€šçŸ¥è¨­å®šèª¬æ˜ -->
    <div class="table-section">
      <h2>ğŸ”” LINEé€šçŸ¥è¨­å®šã‚¬ã‚¤ãƒ‰</h2>
      
      <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="line-setup-section">
        <h3 class="line-setup-title">ğŸ“± Botå‹ã ã¡è¿½åŠ </h3>
        <div class="line-qr-container">
          <img src="{{ url_for('static', filename='images/line_qr.jpg') }}" alt="LINE Bot QRCode" style="width: 150px; height: 150px; border: 2px solid #ddd; border-radius: 8px;">
          <p class="line-qr-description">ä¸Šè¨˜QRã‚³ãƒ¼ãƒ‰ã§Botå‹ã ã¡è¿½åŠ </p>
          <a href="https://line.me/R/ti/p/@275gmabd" target="_blank" class="btn btn-info line-open-btn">ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</a>
        </div>
        
        <div class="line-instructions">
          <p class="line-instructions-title">è¨­å®šæ‰‹é †:</p>
          <ol class="line-instructions-list">
            <li>ä¸Šè¨˜QRã‚³ãƒ¼ãƒ‰ã§Botã‚’å‹ã ã¡è¿½åŠ </li>
            <li>ç®¡ç†è€…ã«ã€Œå‹ã ã¡è¿½åŠ å®Œäº†ã€ã‚’å ±å‘Š</li>
            <li>ç®¡ç†è€…ãŒLINEç®¡ç†ç”»é¢ã§User IDã‚’ç¢ºèª</li>
            <li>å·¦ãƒ•ã‚©ãƒ¼ãƒ ã®ã€ŒLINE User IDã€æ¬„ã«User IDã‚’å…¥åŠ›</li>
            <li>é€šçŸ¥è¨­å®šã‚’é¸æŠã—ã¦ä¿å­˜</li>
          </ol>
        </div>
      </div>

      <!-- ç®¡ç†è€…å‘ã‘èª¬æ˜ -->
      <div class="line-admin-guide">
        <h4 class="line-admin-title">ğŸ‘¤ ç®¡ç†è€…å‘ã‘: User IDç¢ºèªæ–¹æ³•</h4>
        <div class="line-admin-steps">
          <ol>
            <li><strong>LINE Official Account Manager</strong> (https://manager.line.biz/) ã«ãƒ­ã‚°ã‚¤ãƒ³</li>
            <li><strong>@275gmabd</strong> ã‚’é¸æŠ</li>
            <li><strong>ã€Œåˆ†æã€</strong>ã¾ãŸã¯<strong>ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€</strong>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å‹ã ã¡ä¸€è¦§ã‚’ç¢ºèª</li>
            <li>æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸå‹ã ã¡ã®<strong>User ID</strong>ï¼ˆUã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
            <li>ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦ä¿å­˜</li>
          </ol>
        </div>
      </div>

      <!-- è¨­å®šçŠ¶æ³è¡¨ç¤º -->
      {% if user and user.line_id %}
      <div class="line-status-connected-display">
        <h4 class="line-status-title">âœ… LINEé€£æºæ¸ˆã¿</h4>
        <p class="line-status-details">
          User ID: {{ user.line_id[:15] }}...<br>
          é€šçŸ¥: {{ 'æœ‰åŠ¹' if user.line_notification_enabled else 'ç„¡åŠ¹' }} 
          ({{ user.notification_minutes_before if user.notification_minutes_before else 10 }}åˆ†å‰)
        </p>
      </div>
      {% else %}
      <div class="line-status-not-connected-display">
        <h4 class="line-status-title">âš ï¸ LINEæœªè¨­å®š</h4>
        <p class="line-status-details">
          é€è¿æ™‚é–“ã®è‡ªå‹•é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯LINEè¨­å®šãŒå¿…è¦ã§ã™
        </p>
      </div>
      {% endif %}

      <!-- æ©Ÿèƒ½èª¬æ˜ -->
      <div class="line-feature-info">
        <h4 class="line-feature-title">ğŸ’¬ LINEé€šçŸ¥æ©Ÿèƒ½ã«ã¤ã„ã¦</h4>
        <ul class="line-feature-list">
          <li>é€è¿æ™‚é–“ã®æŒ‡å®šåˆ†å‰ã«è‡ªå‹•é€šçŸ¥</li>
          <li>é€šçŸ¥æ™‚é–“ã¯å€‹åˆ¥è¨­å®šå¯èƒ½ï¼ˆ5ã€œ30åˆ†å‰ï¼‰</li>
          <li>é€šçŸ¥ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆå¯èƒ½</li>
          <li>å¤šåº—èˆ—å¯¾å¿œï¼ˆç®¡ç†è€…ãŒå„ã‚¹ã‚¿ãƒƒãƒ•ã®User IDã‚’è¨­å®šï¼‰</li>
        </ul>
      </div>

      <!-- é€è¿é€šçŸ¥ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div class="line-preview-section">
        <h4 class="line-preview-title">ğŸ“± é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹</h4>
        <div class="line-message-preview">
          <div class="line-message-header">ğŸš— é€è¿æ™‚é–“ã®ãŠçŸ¥ã‚‰ã›</div>
          <div class="line-message-body">
            {{ user.name if user else 'ã‚¹ã‚¿ãƒƒãƒ•å' }}æ§˜<br><br>
            16:30ã®é€è¿æ™‚é–“ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚<br>
            æº–å‚™ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚<br><br>
            <small>é€è¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
    const colorInput = document.getElementById('color');
    const colorPreview = document.getElementById('color-preview');
    
    if (colorInput && colorPreview) {
        // åˆæœŸå€¤ã‚’è¨­å®š
        colorPreview.style.backgroundColor = colorInput.value;
        colorPreview.textContent = colorInput.value;
        
        // å¤‰æ›´æ™‚ã®å‡¦ç†
        colorInput.addEventListener('input', function() {
            colorPreview.style.backgroundColor = this.value;
            colorPreview.textContent = this.value;
        });
    }
});
</script>
{% endblock %}