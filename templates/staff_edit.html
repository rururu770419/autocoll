{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_edit.css') }}">
{% endblock %}

{% block title %}
  {% if mode == 'new' %}新規スタッフ登録{% else %}{{ user.name }}さんの編集{% endif %} | {{ display_name }}
{% endblock %}

{% block content %}
<div class="cast-edit-container">
  <h1>
    {% if mode == 'new' %}
      新規スタッフ登録
    {% else %}
      {{ user.name }}さんの編集
    {% endif %}
  </h1>

  {% if success %}
  <div class="cast-edit-flash cast-edit-flash-success">
    {{ success }}
    <button type="button" class="cast-edit-flash-close" onclick="this.parentElement.remove()">&times;</button>
  </div>
  {% endif %}

  {% if error %}
  <div class="cast-edit-flash cast-edit-flash-error">
    {{ error }}
    <button type="button" class="cast-edit-flash-close" onclick="this.parentElement.remove()">&times;</button>
  </div>
  {% endif %}

  <!-- 戻るボタン -->
  <div class="staff-edit-back-section">
    <a href="{{ url_for('main_routes.register_staff', store=store) }}" class="cast-edit-back-btn">← スタッフ一覧に戻る</a>
  </div>

  <div class="page-layout">
    <!-- 基本情報フォーム -->
    <div class="form-section">
      <h2>{% if mode == 'new' %}基本情報登録{% else %}基本情報編集{% endif %}</h2>

      <form method="post" action="{{ url_for('main_routes.save_staff', store=store) }}" class="staff-edit-form">
        {% if mode == 'edit' and user %}
          <input type="hidden" name="user_id" value="{{ user.id }}">
        {% endif %}

        <!-- 基本情報テーブル -->
        <table class="cast-edit-info-table">
          <!-- 1. 名前 -->
          <tr>
            <th>名前</th>
            <td colspan="3">
              <input type="text" name="name" class="cast-edit-input"
                     value="{{ user.name if user else '' }}" required>
            </td>
          </tr>

          <!-- 2. カラー -->
          <tr>
            <th>カラー</th>
            <td colspan="3">
              <div class="color-picker-group">
                <input type="color" name="color_picker" id="colorPicker"
                       value="{{ user.color if user and user.color else '#FFE5E5' }}">
                <input type="text" name="color" id="colorCode" class="cast-edit-input"
                       value="{{ user.color if user and user.color else '#FFE5E5' }}"
                       placeholder="#000000" pattern="^#[0-9A-Fa-f]{6}$">
              </div>
            </td>
          </tr>

          <!-- 3. ログインID -->
          <tr>
            <th>ログインID</th>
            <td colspan="3">
              <input type="text" name="login_id" class="cast-edit-input"
                     value="{{ user.login_id if user else '' }}" required>
            </td>
          </tr>

          <!-- 4. パスワード -->
          <tr>
            <th>パスワード</th>
            <td colspan="3">
              <input type="password" name="password" class="cast-edit-input"
                     value="{{ user.password if user else '' }}"
                     placeholder="{% if user %}変更する場合のみ入力{% else %}必須{% endif %}"
                     {% if not user %}required{% endif %}>
            </td>
          </tr>

          <!-- 5. 権限 -->
          <tr>
            <th>権限</th>
            <td colspan="3">
              <div class="permission-buttons">
                <button type="button" class="permission-btn {% if not user or user.role == 'スタッフ' %}permission-btn-active{% endif %}"
                        data-permission="スタッフ">スタッフ</button>
                <button type="button" class="permission-btn {% if user and user.role == 'ドライバー' %}permission-btn-active{% endif %}"
                        data-permission="ドライバー">ドライバー</button>
                <input type="hidden" name="role" value="{{ user.role if user else 'スタッフ' }}">
              </div>
            </td>
          </tr>

          <!-- 6. LINE User ID -->
          <tr>
            <th>LINE User ID</th>
            <td colspan="3">
              <input type="text" name="line_id" class="cast-edit-input"
                     value="{{ user.line_id if user and user.line_id else '' }}"
                     placeholder="U1a2b3c4d5e6f7g8h9... (Uで始まる文字列)">
            </td>
          </tr>

          <!-- 7. 通知タイミング -->
          <tr>
            <th>通知タイミング</th>
            <td colspan="3">
              <select name="notification_minutes_before" class="cast-edit-select">
                <option value="5" {% if user and user.notification_minutes_before == 5 %}selected{% endif %}>5分前</option>
                <option value="10" {% if not user or user.notification_minutes_before == 10 %}selected{% endif %}>10分前</option>
                <option value="15" {% if user and user.notification_minutes_before == 15 %}selected{% endif %}>15分前</option>
                <option value="20" {% if user and user.notification_minutes_before == 20 %}selected{% endif %}>20分前</option>
                <option value="30" {% if user and user.notification_minutes_before == 30 %}selected{% endif %}>30分前</option>
              </select>
            </td>
          </tr>

          <!-- 8. LINE通知 -->
          <tr>
            <th>LINE通知</th>
            <td colspan="3">
              <div class="toggle-switch">
                <span class="toggle-label">無効</span>
                <label class="switch">
                  <input type="checkbox" name="line_notification_enabled"
                         {% if not user or user.line_notification_enabled %}checked{% endif %}>
                  <span class="slider"></span>
                </label>
                <span class="toggle-label">有効</span>
              </div>
            </td>
          </tr>
        </table>

        <!-- ボタンエリア -->
        <div class="cast-edit-buttons">
          <button type="submit" class="cast-edit-submit-btn">
            {% if mode == 'new' %}登録{% else %}更新{% endif %}
          </button>
          {% if mode == 'edit' and user %}
          <a href="{{ url_for('main_routes.delete_staff_by_id', store=store, user_id=user.id) }}"
             class="cast-edit-delete-btn"
             onclick="return confirm('本当に{{ user.name }}さんを削除しますか？');">削除</a>
          {% endif %}
        </div>
      </form>
    </div>

    <!-- LINE通知設定説明 -->
    <div class="table-section">
      <h2>🔔 LINE通知設定ガイド</h2>

      <!-- QRコード表示エリア（動的） -->
      <div class="line-setup-section">
        <h3 class="line-setup-title">📱 Bot友だち追加</h3>

        {% if line_bot_id %}
        <div class="line-qr-container">
          <!-- 動的QRコード生成 -->
          <img src="https://qr-official.line.me/gs/M_{{ line_bot_id.replace('@', '') }}_GW.png"
               alt="LINE Bot QRCode"
               style="width: 200px; height: 200px; border: 2px solid #ddd; border-radius: 8px;">
          <p class="line-qr-description">上記QRコードでBot友だち追加</p>
          <p class="line-bot-id-display">Bot ID: <strong>{{ line_bot_id }}</strong></p>
          <a href="https://line.me/R/ti/p/{{ line_bot_id }}" target="_blank" class="btn btn-info line-open-btn">
            📱 スマホで開く
          </a>
        </div>
        {% else %}
        <div class="line-qr-container" style="background: #fff3cd; padding: 20px; border-radius: 8px;">
          <p style="color: #856404; margin: 0;">
            ⚠️ LINE Bot IDが設定されていません。<br>
            管理者に連絡して、設定画面でLINE Bot IDを設定してもらってください。
          </p>
        </div>
        {% endif %}

        <div class="line-instructions">
          <p class="line-instructions-title">✨ かんたん3ステップ:</p>
          <ol class="line-instructions-list">
            <li>上記QRコード{% if line_bot_id %}（{{ line_bot_id }}）{% endif %}でBotを友だち追加</li>
            <li>トークで「<strong>ID確認</strong>」と送信</li>
            <li>返信されたUser IDをコピーして、左の「LINE User ID」欄に貼り付けて保存</li>
          </ol>
          <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-top: 12px;">
            <strong>💡 ポイント:</strong> 管理者に確認してもらう必要はありません！自分で完結できます。
          </div>
        </div>
      </div>

      <!-- 設定状況表示 -->
      {% if user and user.line_id %}
      <div class="line-status-connected-display">
        <h4 class="line-status-title">✅ LINE連携済み</h4>
        <p class="line-status-details">
          User ID: {{ user.line_id[:15] }}...<br>
          通知: {{ '有効' if user.line_notification_enabled else '無効' }}
          ({{ user.notification_minutes_before if user.notification_minutes_before else 10 }}分前)
        </p>
      </div>
      {% else %}
      <div class="line-status-not-connected-display">
        <h4 class="line-status-title">⚠️ LINE未設定</h4>
        <p class="line-status-details">
          送迎時間の自動通知を受け取るにはLINE設定が必要です
        </p>
      </div>
      {% endif %}

      <!-- 機能説明 -->
      <div class="line-feature-info">
        <h4 class="line-feature-title">💬 LINE通知機能について</h4>
        <ul class="line-feature-list">
          <li>送迎時間の指定分前に自動通知</li>
          <li>通知時間は個別設定可能（5〜30分前）</li>
          <li>通知のON/OFF切り替え可能</li>
          <li>多店舗対応（各店舗のLINE Botに対応）</li>
        </ul>
      </div>

      <!-- 送迎通知のプレビュー -->
      <div class="line-preview-section">
        <h4 class="line-preview-title">📱 通知メッセージ例</h4>
        <div class="line-message-preview">
          <div class="line-message-header">🚗 送迎時間のお知らせ</div>
          <div class="line-message-body">
            {{ user.name if user else 'スタッフ名' }}様<br><br>
            16:30の送迎時間が近づいています。<br>
            準備をお願いします。<br><br>
            <small>送迎管理システム</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/staff_edit.js') }}"></script>
{% endblock %}
