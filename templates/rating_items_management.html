{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rating.css') }}">
{% endblock %}

{% block title %}評価項目マスタ管理 | {{ display_name }}{% endblock %}

{% block content %}
<div class="rating-container">
    <h1 class="rating-title">評価項目マスタ管理</h1>
    
    <!-- メッセージエリア -->
    <div id="rating-message-area">
        {% if success %}
            <div class="rating-alert rating-alert-success">{{ success }}</div>
        {% endif %}
        {% if error %}
            <div class="rating-alert rating-alert-error">{{ error }}</div>
        {% endif %}
    </div>
    
    <!-- 新規登録ボタン -->
    <div class="rating-btn-new-wrapper">
        <a href="{{ url_for('main_routes.rating_item_registration', store=store) }}" class="rating-btn-new">
            <i class="fas fa-plus-circle"></i> 新規登録
        </a>
    </div>
    
    <!-- 評価項目一覧テーブル -->
    <h2 class="rating-section-title">評価項目一覧</h2>

    <!-- テキストエリア制限の警告メッセージ -->
    <div style="margin-bottom: 15px; padding: 10px 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
        <span style="color: #dc3545; font-weight: 600;">
            <i class="fas fa-exclamation-triangle"></i> 仕様の為、テキストエリアは１つしか作成できません。
        </span>
    </div>

    <div class="rating-list-card">
        <div class="rating-table-wrapper">
            {% if items and items|length > 0 %}
            <table class="rating-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">並び順</th>
                        <th>項目名</th>
                        <th style="width: 140px;">タイプ</th>
                        <th>選択肢</th>
                        <th style="width: 80px;">ステータス</th>
                        <th style="width: 80px;">編集</th>
                        <th style="width: 80px;">削除</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <!-- 並び順 -->
                        <!-- 並び順 -->
                        <td>
                            <button onclick="moveItem({{ item.item_id }}, 'up')" 
                                    class="rating-sort-btn {% if loop.first %}rating-sort-btn-disabled{% endif %}"
                                    {% if loop.first %}disabled{% endif %}
                                    title="上に移動">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button onclick="moveItem({{ item.item_id }}, 'down')" 
                                    class="rating-sort-btn {% if loop.last %}rating-sort-btn-disabled{% endif %}"
                                    {% if loop.last %}disabled{% endif %}
                                    title="下に移動">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </td>
                        <!-- 項目名 -->
                        <td>{{ item.item_name }}</td>
                        
                        <!-- タイプ -->
                        <td>
                            {% if item.item_type == 'radio' %}
                                ラジオボタン
                            {% elif item.item_type == 'checkbox' %}
                                チェックボックス
                            {% elif item.item_type == 'textarea' %}
                                テキストエリア
                            {% endif %}
                        </td>
                        
                        <!-- 選択肢 -->
                        <td>
                            {% if item.item_type != 'textarea' %}
                                {% for option in item.options_list %}
                                    {{ option.value }}{% if not loop.last %}<br>{% endif %}
                                {% endfor %}
                            {% else %}
                                <em style="color: #6c757d;">自由記述</em>
                            {% endif %}
                        </td>
                        
                        <!-- ステータス -->
                        <td>
                            {% if item.is_active %}
                                <span class="rating-status-active">有効</span>
                            {% else %}
                                <span class="rating-status-inactive">無効</span>
                            {% endif %}
                        </td>
                        
                        <!-- 編集 -->
                        <td>
                            <a href="{{ url_for('main_routes.edit_rating_item', store=store, item_id=item.item_id) }}" 
                               class="rating-action-btn" 
                               title="編集">
                                <i class="fas fa-pencil-alt rating-edit-icon"></i>
                            </a>
                        </td>
                        
                        <!-- 削除 -->
                        <td>
                            <a href="javascript:void(0);" 
                               onclick="deleteItem({{ item.item_id }}, '{{ item.item_name }}')" 
                               class="rating-action-btn" 
                               title="削除">
                                <i class="fas fa-trash-alt rating-delete-icon"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="padding: 30px; text-align: center; color: #6c757d;">
                <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>評価項目が登録されていません。</p>
                <p>「新規登録」ボタンから最初の評価項目を登録してください。</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const store = "{{ store }}";

// 並び順変更
function moveItem(itemId, direction) {
    fetch(`/${store}/api/rating_item/move`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            item_id: itemId, 
            direction: direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            showMessage(data.error || '並び替えに失敗しました', 'error');
        }
    })
    .catch(error => {
        showMessage('通信エラー: ' + error, 'error');
    });
}

// 削除
function deleteItem(itemId, itemName) {
    if (!confirm(`「${itemName}」を削除してもよろしいですか？`)) {
        return;
    }
    
    fetch(`/${store}/api/rating_item/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({item_id: itemId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || '削除しました', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showMessage(data.error || '削除に失敗しました', 'error');
        }
    })
    .catch(error => {
        showMessage('通信エラー: ' + error, 'error');
    });
}

// メッセージ表示
function showMessage(message, type) {
    const messageArea = document.getElementById('rating-message-area');
    const alertClass = type === 'success' ? 'rating-alert-success' : 'rating-alert-error';
    
    messageArea.innerHTML = `
        <div class="rating-alert ${alertClass}">
            ${message}
        </div>
    `;
    
    // 上部にスクロール
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // 3秒後に自動で消す
    setTimeout(() => {
        messageArea.innerHTML = '';
    }, 3000);
}
</script>
{% endblock %}