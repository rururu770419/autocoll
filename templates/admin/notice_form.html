{% extends "base.html" %}

{% block title %}{% if notice %}ãŠçŸ¥ã‚‰ã›ç·¨é›†{% else %}ãŠçŸ¥ã‚‰ã›æ–°è¦ä½œæˆ{% endif %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notice_admin.css') }}">
{% endblock %}

{% block content %}
<div class="na-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="na-header">
        <h1 class="na-title">
            {% if notice %}
            âœï¸ ãŠçŸ¥ã‚‰ã›ç·¨é›†
            {% else %}
            â• ãŠçŸ¥ã‚‰ã›æ–°è¦ä½œæˆ
            {% endif %}
        </h1>
        <a href="{{ url_for('notice_admin.list_notices', store=store) }}" class="na-btn na-btn-back">
            â† ä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>

    <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="na-alert {% if category == 'success' %}na-alert-success{% else %}na-alert-error{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="na-card">
        <div class="na-card-body">
            <form method="POST" id="noticeForm">
                
                <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                <div class="na-form-group">
                    <label for="title" class="na-form-label">
                        ã‚¿ã‚¤ãƒˆãƒ«<span class="na-form-required">*</span>
                    </label>
                    <input type="text" 
                           id="title" 
                           name="title" 
                           class="na-form-input" 
                           placeholder="ãŠçŸ¥ã‚‰ã›ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                           value="{{ form_data.title if form_data else (notice.title if notice else '') }}"
                           required>
                </div>

                <!-- æœ¬æ–‡ï¼ˆTinyMCEï¼‰ -->
                <div class="na-editor-container">
                    <label for="content" class="na-editor-label">
                        æœ¬æ–‡<span class="na-form-required">*</span>
                    </label>
                    <textarea id="content" 
                              name="content" 
                              class="na-form-textarea">{{ form_data.content if form_data else (notice.content if notice else '') }}</textarea>
                </div>

                <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š -->
                <div class="na-form-group">
                    <label class="na-form-label">ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</label>
                    
                    <!-- ãƒ”ãƒ³ç•™ã‚ -->
                    <div class="na-form-check">
                        <input type="checkbox" 
                               id="is_pinned" 
                               name="is_pinned" 
                               class="na-form-check-input"
                               {% if form_data %}
                                   {% if form_data.get('is_pinned') %}checked{% endif %}
                               {% elif notice and notice.is_pinned %}
                                   checked
                               {% endif %}>
                        <label for="is_pinned" class="na-form-check-label">
                            ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ï¼ˆä¸€è¦§ã®ä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤ºï¼‰
                        </label>
                    </div>

                    <!-- å…¬é–‹/éå…¬é–‹ -->
                    <div class="na-form-check">
                        <input type="checkbox" 
                               id="is_published" 
                               name="is_published" 
                               class="na-form-check-input"
                               {% if form_data %}
                                   {% if form_data.get('is_published') %}checked{% endif %}
                               {% elif notice %}
                                   {% if notice.is_published %}checked{% endif %}
                               {% else %}
                                   checked
                               {% endif %}>
                        <label for="is_published" class="na-form-check-label">
                            âœ“ å…¬é–‹ã™ã‚‹ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨éå…¬é–‹ï¼‰
                        </label>
                    </div>
                </div>

                <!-- å…¬é–‹æ—¥æ™‚ -->
                <div class="na-form-group">
                    <label for="published_at" class="na-form-label">
                        å…¬é–‹æ—¥æ™‚
                    </label>
                    <input type="datetime-local" 
                           id="published_at" 
                           name="published_at" 
                           class="na-form-input"
                           value="{% if form_data and form_data.published_at %}{{ form_data.published_at }}{% elif notice and notice.published_at %}{{ notice.published_at.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                    <small style="color: #666; font-size: 14px; display: block; margin-top: 5px;">
                        â€» æœªè¨­å®šã®å ´åˆã¯ç¾åœ¨ã®æ—¥æ™‚ãŒä½¿ç”¨ã•ã‚Œã¾ã™
                    </small>
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="na-form-actions">
                    <button type="submit" class="na-btn na-btn-success">
                        ğŸ’¾ ä¿å­˜ã™ã‚‹
                    </button>
                    <a href="{{ url_for('notice_admin.list_notices', store=store) }}" class="na-btn na-btn-secondary">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- TinyMCE CDN -->
<script src="https://cdn.tiny.cloud/1/pl2krs2u7sayrkqfjyfv4309snfbr02ai2dhe7cfp117r0k5/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<script>
// TinyMCEã®åˆæœŸåŒ–
tinymce.init({
    selector: '#content',
    height: 500,
    menubar: false,
    language: 'ja',
    plugins: [
        'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
        'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
        'insertdatetime', 'media', 'table', 'help', 'wordcount'
    ],
    toolbar: 'undo redo | formatselect | bold italic underline strikethrough | ' +
             'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
             'bullist numlist outdent indent | link image | removeformat | help',
    
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®šï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    images_upload_url: "{{ url_for('notice_admin.upload_image', store=store) }}",
    automatic_uploads: true,
    images_reuse_filename: false,
    file_picker_types: 'image',
    
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¿ã‚¤ãƒ«
    content_style: 'body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; font-size: 16px; line-height: 1.6; }',
    
    // æ—¥æœ¬èªç¿»è¨³ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
    language_url: 'https://cdn.jsdelivr.net/npm/tinymce-i18n/langs6/ja.js'
});

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.getElementById('noticeForm').addEventListener('submit', function(e) {
    var title = document.getElementById('title').value.trim();
    var content = tinymce.get('content').getContent();
    
    if (!title) {
        e.preventDefault();
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return false;
    }
    
    if (!content || content === '<p></p>' || content === '') {
        e.preventDefault();
        alert('æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return false;
    }
});
</script>
{% endblock %}