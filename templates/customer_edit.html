{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/reservation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
<script src="{{ url_for('static', filename='js/address.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/customer_edit.js') }}" defer></script>
{% endblock %}
{% block title %}顧客編集 - {{ display_name }}{% endblock %}

{% block content %}
<!-- ローディングオーバーレイ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">読み込み中...</p>
</div>

<!-- ヘッダー -->
<div class="customer-header customer-edit-header">
    <h1>顧客編集</h1>
    <div class="customer-header-buttons">
        <a href="{{ url_for('reservation.new_reservation', store=store, customer_id=customer_id) }}"
           class="customer-btn-register">
            <i class="fas fa-plus"></i> 新規予約登録
        </a>
        <a href="{{ url_for('main_routes.point_history', store=store) }}?customer_id={{ customer_id }}"
           class="customer-btn-point-history">
            <i class="fas fa-history"></i> PT履歴
        </a>
        <a href="{{ url_for('main_routes.customer_management', store=store) }}" class="customer-back-btn">
            ← 一覧に戻る
        </a>
    </div>
</div>

<!-- メッセージエリア -->
<div id="messageArea"></div>

<!-- 予約登録ページと同じレイアウト -->
<div class="customer-container reservation-container" id="mainContent" style="opacity: 0; pointer-events: none;">
    <!-- ========== 列1：顧客情報入力カード（メインカラー背景） ========== -->
    <div class="customer-info-area">
        <div class="customer-info-card">
            <div class="customer-info-content">
                <!-- 名前 -->
                <div class="customer-form-group">
                    <label class="customer-label-white">名前</label>
                    <input type="text" name="name" id="name" class="customer-input form-input-white" required>
                </div>

                <!-- フリガナ -->
                <div class="customer-form-group">
                    <label class="customer-label-white">フリガナ</label>
                    <input type="text" name="furigana" id="furigana" class="customer-input form-input-white">
                </div>

                <!-- ニックネーム -->
                <div class="customer-form-group">
                    <label class="customer-label-white">ニックネーム</label>
                    <input type="text" name="nickname" id="nickname" class="customer-input form-input-white">
                </div>

                <!-- 生年月日 -->
                <div class="customer-form-group">
                    <label class="customer-label-white">生年月日</label>
                    <input type="date" name="birthday" id="birthday" class="customer-input form-input-white">
                </div>

                <!-- 年齢（自動計算） -->
                <div class="customer-form-group">
                    <label class="customer-label-white">年齢</label>
                    <input type="text" id="age" class="customer-input customer-input-readonly form-input-white"
                           readonly placeholder="年齢">
                </div>

                <!-- 所持PT -->
                <div class="customer-form-group">
                    <label class="customer-label-white">所持PT</label>
                    <div class="customer-input-group">
                        <input type="number" name="current_points" id="current_points"
                               class="customer-input customer-input-readonly form-input-white" value="0" min="0" step="1" inputmode="numeric" readonly>
                        <span class="customer-input-suffix-white">pt</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 列2-4：フォームエリア ========== -->
    <div class="reservation-form-area">
        <form id="customerForm" class="customer-form">
            <input type="hidden" id="customerId" value="{{ customer_id }}">

            <!-- ========== 1行目 ========== -->
            <!-- 顧客番号（列1） -->
            <div class="customer-form-field">
                <label>顧客番号</label>
                <input type="text" name="customer_number" id="customer_number"
                       class="customer-field-input" readonly>
            </div>

            <!-- 都道府県（列2） -->
            <div class="customer-form-field">
                <label>都道府県</label>
                <select name="prefecture" id="prefecture" class="customer-field-select">
                    <option value="">都道府県</option>
                    <option value="北海道">北海道</option>
                    <option value="青森県">青森県</option>
                    <option value="岩手県">岩手県</option>
                    <option value="宮城県">宮城県</option>
                    <option value="秋田県">秋田県</option>
                    <option value="山形県">山形県</option>
                    <option value="福島県">福島県</option>
                    <option value="茨城県">茨城県</option>
                    <option value="栃木県">栃木県</option>
                    <option value="群馬県">群馬県</option>
                    <option value="埼玉県">埼玉県</option>
                    <option value="千葉県">千葉県</option>
                    <option value="東京都">東京都</option>
                    <option value="神奈川県">神奈川県</option>
                    <option value="新潟県">新潟県</option>
                    <option value="富山県">富山県</option>
                    <option value="石川県">石川県</option>
                    <option value="福井県">福井県</option>
                    <option value="山梨県">山梨県</option>
                    <option value="長野県">長野県</option>
                    <option value="岐阜県">岐阜県</option>
                    <option value="静岡県">静岡県</option>
                    <option value="愛知県">愛知県</option>
                    <option value="三重県">三重県</option>
                    <option value="滋賀県">滋賀県</option>
                    <option value="京都府">京都府</option>
                    <option value="大阪府">大阪府</option>
                    <option value="兵庫県">兵庫県</option>
                    <option value="奈良県">奈良県</option>
                    <option value="和歌山県">和歌山県</option>
                    <option value="鳥取県">鳥取県</option>
                    <option value="島根県">島根県</option>
                    <option value="岡山県">岡山県</option>
                    <option value="広島県">広島県</option>
                    <option value="山口県">山口県</option>
                    <option value="徳島県">徳島県</option>
                    <option value="香川県">香川県</option>
                    <option value="愛媛県">愛媛県</option>
                    <option value="高知県">高知県</option>
                    <option value="福岡県">福岡県</option>
                    <option value="佐賀県">佐賀県</option>
                    <option value="長崎県">長崎県</option>
                    <option value="熊本県">熊本県</option>
                    <option value="大分県">大分県</option>
                    <option value="宮崎県">宮崎県</option>
                    <option value="鹿児島県">鹿児島県</option>
                    <option value="沖縄県">沖縄県</option>
                </select>
            </div>

            <!-- 会員種別（列3） -->
            <div class="customer-form-field">
                <label>会員種別</label>
                <select name="member_type" id="member_type" class="customer-field-select">
                    <!-- JavaScriptで動的生成 -->
                </select>
            </div>

            <!-- ========== 2行目 ========== -->
            <!-- 電話番号（列1） -->
            <div class="customer-form-field">
                <label>電話番号</label>
                <input type="tel" name="phone" id="phone" class="customer-field-input"
                       placeholder="09012345678" pattern="[0-9]{11}" maxlength="11" inputmode="numeric"
                       title="数字11桁で入力してください">
            </div>

            <!-- 市区町村（列2） -->
            <div class="customer-form-field">
                <label>市区町村</label>
                <select name="city" id="city" class="customer-field-select">
                    <option value="">市区町村</option>
                </select>
            </div>

            <!-- ステータス（列3） -->
            <div class="customer-form-field">
                <label>ステータス</label>
                <select name="status" id="status" class="customer-field-select">
                    <!-- JavaScriptで動的生成 -->
                </select>
            </div>

            <!-- ========== 3行目 ========== -->
            <!-- マイページID（列1） -->
            <div class="customer-form-field">
                <label>ログインID</label>
                <input type="text" name="mypage_id" id="mypage_id" class="customer-field-input"
                       placeholder="ログインID" autocomplete="off"
                       pattern="[a-zA-Z0-9_\-@.]+" title="半角英数字、記号（_ - @ .）のみ">
            </div>

            <!-- 住所詳細（列2） - 1つのinputフィールド -->
            <div class="customer-form-field">
                <label>住所詳細</label>
                <input type="text" name="street_address" id="street_address"
                       class="customer-field-input" placeholder="建物、番地など">
            </div>

            <!-- WEB会員（列3） -->
            <div class="customer-form-field">
                <label>WEB会員</label>
                <select name="web_member" id="web_member" class="customer-field-select">
                    <!-- JavaScriptで動的生成 -->
                </select>
            </div>

            <!-- building_nameフィールドは非表示で残す（既存データとの互換性のため） -->
            <input type="hidden" name="building_name" id="building_name" value="">

            <!-- ========== 4行目 ========== -->
            <!-- パスワード（列1） -->
            <div class="customer-form-field">
                <label>パスワード</label>
                <input type="text" name="mypage_password" id="mypage_password" class="customer-field-input"
                       placeholder="変更する場合のみ" autocomplete="new-password"
                       pattern="[\x20-\x7E]+" title="半角文字のみ">
            </div>

            <!-- 車情報（列2）【新規追加】 -->
            <div class="customer-form-field">
                <label>車情報</label>
                <input type="text" name="car_info" id="car_info"
                       class="customer-field-input" placeholder="車種・ナンバーなど">
            </div>

            <!-- 募集媒体（列3） -->
            <div class="customer-form-field">
                <label>募集媒体</label>
                <select name="recruitment_source" id="recruitment_source" class="customer-field-select">
                    <!-- JavaScriptで動的生成 -->
                </select>
            </div>

            <!-- ========== 5行目：ポイント操作 ========== -->
            <div class="form-full-width">
                <div class="point-operation-container">
                    <!-- 操作 -->
                    <div class="point-field">
                        <label>操作</label>
                        <select name="point_operation" id="point_operation" class="customer-field-select point-operation-select">
                            <option value="">選択してください</option>
                            <option value="add">追加</option>
                            <option value="consume">消費</option>
                        </select>
                    </div>

                    <!-- ポイント数 -->
                    <div class="point-field">
                        <label>ポイント数</label>
                        <div class="point-input-group">
                            <input type="number" name="point_amount" id="point_amount" class="point-amount-input"
                                   placeholder="0" min="0" step="1" inputmode="numeric">
                            <span class="point-suffix">PT</span>
                        </div>
                    </div>

                    <!-- 理由 -->
                    <div class="point-field">
                        <label>理由（任意）</label>
                        <select name="point_reason" id="point_reason" class="customer-field-select point-reason-select">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ========== 6行目：コメント（列1-3全幅） ========== -->
            <div class="form-full-width">
                <div class="customer-form-field">
                    <label>コメント</label>
                    <textarea name="comment" id="comment" class="customer-field-textarea"
                              rows="3" placeholder="備考・メモなど"></textarea>
                </div>
            </div>

            <!-- ========== ボタン（列1-3全幅） ========== -->
            <div class="form-full-width form-actions">
                <button type="submit" class="btn-submit">更新</button>
                <button type="button" onclick="deleteCustomer()" class="btn-reset">削除</button>
            </div>
        </form>

        <!-- ========== 利用履歴・利用キャストエリア ========== -->
        <div class="customer-usage-container">
            <!-- 利用履歴 -->
            <div class="customer-usage-section">
                <h2 class="usage-section-title">利用履歴</h2>
                <div class="usage-table-container">
                    <table class="usage-table" id="usage-history-table">
                        <thead>
                            <tr>
                                <th>成約種別</th>
                                <th>予約日時</th>
                                <th>キャスト名</th>
                                <th>ホテル名</th>
                            </tr>
                        </thead>
                        <tbody id="usage-history-tbody">
                            <tr>
                                <td colspan="4" class="loading-cell">読み込み中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 利用キャスト -->
            <div class="customer-usage-section">
                <h2 class="usage-section-title">利用キャスト</h2>
                <div class="usage-table-container">
                    <table class="usage-table" id="cast-usage-table">
                        <thead>
                            <tr>
                                <th>キャスト名</th>
                                <th>利用回数</th>
                                <th>最新日時</th>
                            </tr>
                        </thead>
                        <tbody id="cast-usage-tbody">
                            <tr>
                                <td colspan="3" class="loading-cell">読み込み中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
