{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/reservation.css') }}">
<style>
/* テスト用：ドロップダウンを強制表示 */
.options-dropdown {
    display: flex !important;
    flex-direction: column !important;
    position: absolute !important;
    top: calc(100% + 2px) !important;
    left: 0 !important;
    right: 0 !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    background: white !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.15) !important;
    z-index: 9999 !important;
}

.options-dropdown.collapsed {
    display: none !important;
}
</style>
{% endblock %}

{% block title %}予約編集 | {{ display_name }}{% endblock %}

{% block content %}
<!-- ローディングオーバーレイ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">読み込み中...</p>
</div>

<div class="reservation-container" id="mainContent" style="opacity: 0; pointer-events: none;">
    <!-- ========== 第1列：顧客情報表示エリア ========== -->
    <div class="customer-info-area">
        <div class="customer-info-card edit-mode">
            <!-- ページ名 -->
            <div class="reservation-page-label">予約編集</div>

            <!-- 顧客情報 -->
            <div class="customer-info-content">
                <p class="customer-number">顧客番号: {{ customer.get('customer_number', '---') }}</p>
                <h2 class="customer-name">{{ customer.get('name', '名前未登録') }} 様</h2>
                <p class="customer-phone"><i class="fas fa-phone"></i> {{ customer.get('phone', '未登録') }}</p>

                <!-- 来店回数 -->
                <div class="customer-stat-line">
                    <span class="stat-label">来店回数:</span>
                    <span class="stat-value">{{ customer.get('visit_count', 0) }} times</span>
                </div>

                <!-- 現在のPT -->
                <div class="customer-stat-line">
                    <span class="stat-label">現在のPT:</span>
                    <span class="stat-value" id="current_pt_display">{{ "{:,}".format(customer.get('current_points', 0) or 0) }} PT</span>
                </div>

                <!-- 最終キャスト -->
                <div class="customer-stat-line">
                    <span class="stat-label">最終キャスト:</span>
                    <span class="stat-value">{{ customer.get('last_cast_name', '未設定') }}</span>
                </div>

                <!-- 最終来店日時（縦並び） -->
                <div class="customer-stat-line customer-stat-vertical">
                    <span class="stat-label">最終来店日時</span>
                    <span class="stat-value">
                        {% if customer.get('last_visit_datetime') %}
                            {{ customer.get('last_visit_datetime').strftime('%Y年%m月%d日 %H:%M') }}～
                        {% else %}
                            未来店
                        {% endif %}
                    </span>
                </div>

                <!-- 最終利用ホテル（縦並び） -->
                <div class="customer-stat-line customer-stat-vertical">
                    <span class="stat-label">最終利用ホテル</span>
                    <span class="stat-value">{{ customer.get('last_hotel_name', '未設定') }}</span>
                </div>
            </div>

            <!-- 詳細ボタン -->
            <a href="{{ url_for('main_routes.edit_customer', store=store, customer_id=customer.get('customer_id', '')) }}"
               class="customer-detail-btn">
                詳細
            </a>
        </div>

        <!-- 顧客評価ボタン（新規追加） -->
        <button type="button" class="customer-action-btn customer-rating-btn" id="customerRatingBtn" onclick="showCustomerRatingModal({{ customer.get('customer_id', '') }})">
            顧客評価
        </button>

        <!-- 予約一覧に戻るボタン -->
        <a href="{{ url_for('reservation.reservations_list', store=store) }}"
           class="customer-action-btn customer-back-btn">
            予約一覧に戻る
        </a>
    </div>

    <!-- ========== 第2-4列：予約入力フォームエリア ========== -->
    <div class="reservation-form-area">
        <form id="reservation_edit_form">
            <!-- 隠しフィールド -->
            <input type="hidden" id="reservation_id" name="reservation_id" value="{{ reservation.get('reservation_id', '') }}">
            <input type="hidden" id="customer_id" name="customer_id" value="{{ customer.get('customer_id', '') }}">

            <!-- ========== 1行目 ========== -->
            <!-- 成約種別 -->
            <div class="customer-form-field">
                <label>成約種別</label>
                <select id="contract_type" name="contract_type" class="customer-field-select" onchange="toggleCancellation()">
                    <option value="contract">成約</option>
                    <option value="cancel">キャンセル</option>
                </select>
            </div>

            <!-- 予約日 -->
            <div class="customer-form-field">
                <label>予約日</label>
                <div class="date-select-group">
                    <select id="year" class="customer-field-select date-select">
                        <!-- JavaScriptで生成 -->
                    </select>
                    <span class="date-separator">年</span>
                    <select id="month" class="customer-field-select date-select">
                        <!-- JavaScriptで生成 -->
                    </select>
                    <span class="date-separator">月</span>
                    <select id="day" class="customer-field-select date-select">
                        <!-- JavaScriptで生成 -->
                    </select>
                    <span class="date-separator">日</span>
                </div>
                <!-- FormData送信用のhiddenフィールド -->
                <input type="hidden" id="reservation_date" name="reservation_date">
            </div>

            <!-- 予約時間 -->
            <div class="customer-form-field">
                <label>予約時間</label>
                <div class="time-select-group">
                    <select id="hour" class="customer-field-select time-select">
                        <!-- JavaScriptで生成 -->
                    </select>
                    <span class="time-separator">:</span>
                    <select id="minute" class="customer-field-select time-select">
                        <!-- JavaScriptで生成 -->
                    </select>
                </div>
                <!-- FormData送信用のhiddenフィールド -->
                <input type="hidden" id="reservation_time" name="reservation_time">
            </div>

            <!-- ========== 2行目 ========== -->
            <!-- キャスト -->
            <div class="customer-form-field">
                <label>キャスト</label>
                <select id="cast_id" name="cast_id" class="customer-field-select">
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- 指名種類 -->
            <div class="customer-form-field">
                <label>指名種類</label>
                <select id="nomination_type" name="nomination_type" class="customer-field-select" onchange="calculateTotal()">
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- 予約方法 -->
            <div class="customer-form-field">
                <label>予約方法</label>
                <select id="reservation_method" name="reservation_method" class="customer-field-select">
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- ========== 3行目 ========== -->
            <!-- コース -->
            <div class="customer-form-field">
                <label>コース</label>
                <select id="course_id" name="course_id" class="customer-field-select" onchange="calculateTotal()">
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- ホテル名+部屋番号（横並び） -->
            <div class="customer-form-field">
                <label>ホテル名</label>
                <div class="form-group-hotel-room">
                    <select id="hotel_id" name="hotel_id" class="customer-field-select hotel-select">
                        <option value="">選択してください</option>
                    </select>
                    <input type="text" id="room_number" name="room_number" class="customer-field-input room-number-input" placeholder="部屋番号">
                </div>
            </div>

            <!-- 交通費 -->
            <div class="customer-form-field">
                <label>交通費</label>
                <select id="transportation_fee" name="transportation_fee" class="customer-field-select" onchange="calculateTotal()">
                    <option value="0" data-transportation-fee="0">なし</option>
                </select>
            </div>

            <!-- ========== 4行目 ========== -->
            <!-- 延長 -->
            <div class="customer-form-field">
                <label>延長</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="extension" name="extension" class="customer-field-select" onchange="calculateTotal()" style="flex: 1;">
                        <option value="">なし</option>
                    </select>
                    <span style="white-space: nowrap;">回数:</span>
                    <select name="extension_quantity" id="extension_quantity" class="customer-field-select" style="width: 80px;" onchange="calculateTotal()">
                        <option value="0">0回</option>
                        <option value="1">1回</option>
                        <option value="2">2回</option>
                        <option value="3">3回</option>
                        <option value="4">4回</option>
                        <option value="5">5回</option>
                    </select>
                </div>
            </div>

            <!-- オプション（チェックボックス） -->
            <div class="customer-form-field" style="overflow: visible;">
                <label>オプション</label>
                <div class="custom-select-wrapper">
                    <div class="custom-select" id="options-select">
                        <div class="select-display" id="options_select_display">
                            <span class="select-placeholder">オプションを選択してください</span>
                            <span class="select-arrow">▼</span>
                        </div>
                        <div class="options-dropdown collapsed" id="options_container">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 待ち合わせ場所 -->
            <div class="customer-form-field">
                <label>待ち合わせ</label>
                <select id="meeting_place" name="meeting_place" class="customer-field-select">
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- ========== 5行目 ========== -->
            <!-- 割引 -->
            <div class="customer-form-field" style="overflow: visible;">
                <label>割引</label>
                <div class="custom-select-wrapper">
                    <div class="custom-select" id="discount-select">
                        <div class="select-display" id="discount_select_display">
                            <span class="select-placeholder">割引を選択してください</span>
                            <span class="select-arrow">▼</span>
                        </div>
                        <div class="options-dropdown discount-dropdown collapsed" id="discount_container">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 担当スタッフ -->
            <div class="customer-form-field">
                <label>スタッフ</label>
                <select id="staff_id" name="staff_id" class="customer-field-select">
                </select>
            </div>

            <!-- キャンセル理由 -->
            <div class="customer-form-field">
                <label>キャンセル</label>
                <select id="cancellation_reason" name="cancellation_reason" class="customer-field-select" disabled>
                    <option value="">選択してください</option>
                </select>
            </div>

            <!-- ========== 6行目 ========== -->
            <!-- 支払い方法 -->
            <div class="customer-form-field">
                <label>支払い方法</label>
                <select id="payment_method" name="payment_method" class="customer-field-select" onchange="handlePaymentMethodChange()">
                    <option value="">選択してください</option>
                    <option value="cash">現金</option>
                    <option value="card">カード</option>
                    <option value="deferred">後払い</option>
                </select>
            </div>

            <!-- 調整金 -->
            <div class="customer-form-field">
                <label>調整金</label>
                <input type="number" id="adjustment_amount" name="adjustment_amount" class="customer-field-input" placeholder="0" value="0" oninput="calculateTotal()">
            </div>

            <!-- 空白セル（3列目を空ける） -->
            <div></div>

            <!-- ========== 7行目 ========== -->
            <!-- 料金総額 -->
            <div class="customer-form-field">
                <label>料金総額</label>
                <input type="text" id="total_amount" name="total_amount" class="customer-field-input" readonly value="0円">
            </div>

            <!-- 預かり金額（現金時のみ表示） -->
            <div class="customer-form-field" id="change_input_area" style="display: none;">
                <label id="amount_received_label">預かり金額{% if reservation.amount_received and reservation.amount_received > 0 %}<span style="color: white; font-weight: bold;">（登録済み）</span>{% endif %}</label>
                <input type="text" id="amount_received" name="amount_received"
                       class="customer-field-input{% if reservation.amount_received and reservation.amount_received > 0 %} amount-registered{% endif %}" placeholder="0" readonly>
            </div>

            <!-- お釣り（現金時のみ表示） -->
            <div class="customer-form-field" id="change_amount_area" style="display: none;">
                <label>お釣り</label>
                <input type="text" id="change_amount" class="customer-field-input" readonly value="0円">
            </div>

            <!-- ========== 8行目 ========== -->
            <!-- 空白セル -->
            <div></div>

            <!-- PT関連（2-3列、2列分） -->
            <div class="form-group" style="grid-column: span 2;">
                <div class="pt-row">
                    <div class="pt-input-group">
                        <label>PT追加</label>
                        <input type="number" id="pt_add" name="pt_add" class="pt-input" placeholder="0" min="0" oninput="calculatePT()">
                        <span class="pt-unit">PT</span>
                    </div>

                    <div class="pt-input-group">
                        <label>PT消費</label>
                        <input type="number" id="pt_consume" name="pt_consume" class="pt-input" placeholder="0" min="0" oninput="calculatePT()">
                        <span class="pt-unit">PT</span>
                    </div>

                    <div class="pt-result">
                        <label>残PT</label>
                        <span id="remaining_pt" class="pt-value">1,500</span>
                        <span class="pt-unit">PT</span>
                    </div>
                </div>
            </div>

            <!-- ========== 9行目: コメント（列1-3全幅） ========== -->
            <div class="form-full-width">
                <div class="customer-form-field">
                    <label>コメント</label>
                    <textarea id="comment" name="comment" class="customer-field-textarea" rows="3" placeholder="予約に関するコメントを入力"></textarea>
                </div>
            </div>

            <!-- ========== 10行目: 送信ボタン（列1-3全幅） ========== -->
            <div class="form-full-width form-actions">
                {% if reservation.amount_received and reservation.amount_received > 0 %}
                <!-- お預かり金額確定済みの警告メッセージ -->
                <div class="edit-locked-message">
                    <i class="fas fa-lock"></i>
                    キャストによるお預かり金額確定済みなので編集が不可です。
                </div>
                {% endif %}
                <button type="button" class="btn-reset" onclick="window.location.href='{{ url_for('reservation.reservations_list', store=store) }}'">一覧に戻る</button>
                <button type="submit" class="btn-submit" {% if reservation.amount_received and reservation.amount_received > 0 %}disabled{% endif %}>予約更新</button>
                <button type="button" class="btn-delete" onclick="deleteReservation()" {% if reservation.amount_received and reservation.amount_received > 0 %}disabled{% endif %}>削除</button>
            </div>
        </form>
    </div>
</div>

<!-- 顧客評価モーダル -->
<div class="rating-modal" id="ratingModal" style="display: none;">
    <div class="rating-modal-overlay" onclick="closeRatingModal()"></div>
    <div class="rating-modal-content">
        <div class="rating-modal-header">
            <h2>みんなの評価</h2>
            <button class="rating-modal-close" onclick="closeRatingModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="rating-modal-body" id="ratingModalBody">
            <!-- JavaScriptで動的に生成 -->
        </div>
        <div class="rating-modal-footer">
            <button class="rating-modal-close-btn" onclick="closeRatingModal()">閉じる</button>
        </div>
    </div>
</div>

<script>
// 予約データをJavaScriptに渡す
window.reservationData = {{ reservation_json|safe }};
// お釣り機能の設定
window.useChangeFeature = {{ 'true' if use_change_feature else 'false' }};
// 顧客の現在のPTを初期値として設定
// ログイン中のスタッフIDを設定
window.currentCustomerId = {{ customer.get('customer_id', 'null') }};
window.addEventListener('DOMContentLoaded', function() {
    currentCustomerPT = {{ customer.get('current_points', 0) or 0 }};
    window.currentStaffId = {{ session.get('user_id', 'null') }};
    calculatePT(); // PT表示を初期化
    loadCustomerRatingCount(); // 顧客評価件数を取得
});
</script>
<script src="{{ url_for('static', filename='js/reservation_edit.js') }}"></script>
{% endblock %}
