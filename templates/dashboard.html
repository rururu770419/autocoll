{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

<!-- å°‚ç”¨CSSã‚’è¿½åŠ  -->
{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  
    <h1 class="dashboard-title">
      ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      <a href="javascript:void(0)" class="dashboard-pickup-btn" onclick="toggleAnnouncement()">ãŠçŸ¥ã‚‰ã›</a>
    </h1>
    
    <div class="dashboard-save-section">
      <button type="button" class="dashboard-save-btn" onclick="saveAllChanges()">ç¾çŠ¶ã®çŠ¶æ…‹ã‚’ä¿å­˜</button>
      <span id="saveMessage" class="dashboard-save-message">ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</span>
    </div>

    <div class="dashboard-refresh-section">
      <button type="button" class="dashboard-refresh-btn" onclick="refreshDashboard()">æ›´æ–°</button>
      <span id="refreshMessage" class="dashboard-refresh-message">æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</span>
    </div>

    

  {% if success %}
    <div class="dashboard-alert dashboard-alert-success">{{ success }}</div>
  {% endif %}
  {% if error %}
    <div class="dashboard-alert dashboard-alert-error">{{ error }}</div>
  {% endif %}

  <!-- æ—¥ä»˜ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="dashboard-date-navigation">
    <button class="dashboard-date-nav-btn" onclick="changeDate(-1)">â—€</button>
    <span class="dashboard-date-display" id="currentDateDisplay">{{ current_date_display }}</span>
    <button class="dashboard-date-calendar-btn" onclick="openCalendarModal()">ğŸ“…</button>
    <button class="dashboard-date-nav-btn" onclick="changeDate(1)">â–¶</button>
  </div>

  <!-- ãŠçŸ¥ã‚‰ã›ã‚¨ãƒªã‚¢ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–“ã«é…ç½®ï¼‰ -->
  <div id="announcementArea" class="announcement-area" style="display: {% if announcement.is_visible %}block{% else %}none{% endif %};">
    <textarea 
      id="announcementContent" 
      class="announcement-textarea" 
      placeholder="ãŠçŸ¥ã‚‰ã›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
      data-field="announcement"
      data-store="{{ store }}">{{ announcement.content or '' }}</textarea>
  </div>

  <!-- é€è¿è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="dashboard-table-container">
    <div class="dashboard-table-wrapper">
      <table class="dashboard-table" id="pickupTable">
        <tbody>
          {% for record in pickup_records %}
          <tr class="dashboard-record-row{% if record.is_completed %} dashboard-completed{% endif %}{% if record.is_entry %} dashboard-entry-row{% endif %}" 
    id="record-{{ record.record_id }}" 
    data-course-id="{{ record.course_id }}">
            
    <td class="dashboard-cell dashboard-time-cell">
      {% if record.type == 'pickup' %}
        <input type="time" class="dashboard-input dashboard-time-input" 
               id="time-{{ record.record_id }}"
               value="{% if record.is_entry %}{{ record.entry_time.strftime('%H:%M') if record.entry_time else '' }}{% else %}{{ record.exit_time.strftime('%H:%M') if record.exit_time else '' }}{% endif %}"
               data-field="{% if record.is_entry %}entry_time{% else %}exit_time{% endif %}"
               data-record-id="{{ record.record_id }}">
      {% else %}
        <input type="time" class="dashboard-input dashboard-time-input" 
               id="time-{{ record.record_id }}"
               value="{{ record.entry_time.strftime('%H:%M') if record.entry_time else '' }}"
               data-field="entry_time"
               data-record-id="{{ record.record_id }}">
      {% endif %}
    </td>
            
            <!-- æŒ‡åãƒãƒƒã‚¸ã‚»ãƒ« -->
            <td class="dashboard-cell dashboard-nomination-cell">
              {% if record.type == 'pickup' and record.nomination_type %}
                <span class="dashboard-nomination-badge dashboard-nomination-{{ record.nomination_type }}">
                  {% if record.nomination_type == 'æœ¬æŒ‡å' %}æœ¬
                  {% elif record.nomination_type == 'åº—ãƒªãƒ”' %}ãƒª
                  {% elif record.nomination_type == 'æ–°è¦' %}æ–°
                  {% elif record.nomination_type == 'ãƒ•ãƒªãƒ¼' %}ãƒ•
                  {% endif %}
                </span>
              {% endif %}
            </td>
            
            {% if record.type == 'pickup' %}
              <td class="dashboard-cell dashboard-cast-cell">
                <select class="dashboard-input dashboard-cast-select" 
                        id="cast-{{ record.record_id }}"
                        data-field="cast_id"
                        data-record-id="{{ record.record_id }}">
                  <option value="">ã‚­ãƒ£ã‚¹ãƒˆã‚’é¸æŠ</option>
                  {% for cast in casts %}
                    <option value="{{ cast.cast_id }}" {% if cast.cast_id == record.cast_id %}selected{% endif %}>
                      {{ cast.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>
              <td class="dashboard-cell dashboard-hotel-cell">
                <select class="dashboard-input dashboard-hotel-select" 
                        id="hotel-{{ record.record_id }}"
                        data-field="hotel_id"
                        data-record-id="{{ record.record_id }}">
                  <option value="">ãƒ›ãƒ†ãƒ«ã‚’é¸æŠ</option>
                  {% for hotel in hotels %}
                    <option value="{{ hotel.hotel_id }}" {% if hotel.hotel_id == record.hotel_id %}selected{% endif %}>
                      {{ hotel.hotel_name }}
                    </option>
                  {% endfor %}
                </select>
              </td>
            {% else %}
              <td class="dashboard-cell dashboard-content-cell" colspan="2">
                <input type="text" class="dashboard-input dashboard-content-input" 
                       id="content-{{ record.record_id }}"
                       value="{{ record.content }}"
                       data-field="content"
                       data-record-id="{{ record.record_id }}">
              </td>
            {% endif %}
            
            <td class="dashboard-cell dashboard-staff-cell">
              <select class="dashboard-input dashboard-staff-select" 
                      id="staff-{{ record.record_id }}"
                      onchange="updateStaffColor({{ record.record_id }}, this)" 
                      style="background-color: {{ record.staff_color or '#ffffff' }};"
                      data-field="staff_id"
                      data-record-id="{{ record.record_id }}">
                <option value="">æœªå®š</option>
                {% for staff in staff_list %}
                  <option value="{{ staff.login_id }}" data-color="{{ staff.color }}" {% if staff.login_id == record.staff_id %}selected{% endif %}>{{ staff.name }}</option>
                {% endfor %}
              </select>
            </td>
            
            <td class="dashboard-cell dashboard-inout-cell">
              <span class="dashboard-badge{% if record.is_entry %} dashboard-badge-entry{% else %} dashboard-badge-exit{% endif %}">
                {% if record.is_entry %}å…¥{% else %}å‡º{% endif %}
              </span>
            </td>
            
            <!-- é€€å®¤è¡Œã®ã¿ã«ãŠé‡£ã‚Šãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
            {% if not record.is_entry %}
            <td class="dashboard-cell change-button-cell">
              <button class="change-modal-btn" onclick="openChangeModal({{ record.record_id }})">ãŠé‡£ã‚Š</button>
            </td>
            {% else %}
            <td class="dashboard-cell change-button-cell">
              <!-- å…¥å®¤è¡Œã¯ç©ºã®ã‚»ãƒ« -->
            </td>
            {% endif %}
            
            <td class="dashboard-cell dashboard-completed-cell">
              <button class="dashboard-btn{% if record.is_completed %} dashboard-btn-completed{% else %} dashboard-btn-uncompleted{% endif %}" 
                      onclick="toggleCompleted({{ record.record_id }})">
                {% if record.is_completed %}æ¸ˆ{% else %}æœª{% endif %}
              </button>
            </td>
            
            <td class="dashboard-cell dashboard-memo-cell">
              <button class="dashboard-btn dashboard-memo-btn" onclick="toggleMemo({{ record.record_id }})">ãƒ¡ãƒ¢</button>
            </td>
            
            <td class="dashboard-cell dashboard-delete-cell">
              <button class="dashboard-btn dashboard-delete-btn" onclick="deleteRecord({{ record.record_id }})">å‰Šé™¤</button>
            </td>
            
            <!-- ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«ç™ºä¿¡äºˆå®šæ™‚åˆ» -->
            <td class="dashboard-cell dashboard-call-time-cell">
              {% if record.type == 'pickup' and not record.is_entry %}
                <span id="call-time-{{ record.record_id }}">{{ record.call_scheduled_time or '-' }}</span>
              {% endif %}
            </td>
            
            <!-- ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«çŠ¶æ…‹ã‚¢ã‚¤ã‚³ãƒ³ -->
            <td class="dashboard-cell dashboard-call-status-cell">
              {% if record.type == 'pickup' and not record.is_entry %}
                <!-- ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º -->
                <span id="call-status-{{ record.record_id }}" class="call-status-icon" style="font-size: 18px;">
                  {% if record.cast_auto_call_disabled %}â¸ï¸
                  {% elif record.cast_auto_call_sent %}âœ…
                  {% else %}ğŸ“{% endif %}
                </span>
              {% endif %}
            </td>
            
          </tr>
          <!-- ãƒ¡ãƒ¢è¡Œï¼ˆéè¡¨ç¤ºï¼‰ -->
          <tr class="dashboard-memo-row" id="memo-row-{{ record.record_id }}" style="display: {% if record.memo_expanded %}table-row{% else %}none{% endif %};">
            <td class="dashboard-memo-cell-full" colspan="10">
              <textarea class="dashboard-memo-textarea" 
                        id="memo-{{ record.record_id }}" 
                        rows="2" 
                        placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
                        data-record-id="{{ record.record_id }}"
                        data-field="memo">{{ record.memo or '' }}</textarea>
            </td>
            <!-- åˆ—æ•°ã‚’æƒãˆã‚‹ãŸã‚ã®ç©ºã‚»ãƒ« -->
            <td class="dashboard-cell"></td>
            <td class="dashboard-cell"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if not pickup_records %}
    <p class="dashboard-no-records">ã“ã®æ—¥ã®é€è¿è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

  <!-- ãŠé‡£ã‚Šç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="changeModal" class="change-modal">
    <div class="change-modal-content">
      <div class="change-modal-header">
        <h3>ãŠé‡£ã‚Šç™»éŒ²</h3>
        <span class="change-modal-close" onclick="closeChangeModal()">&times;</span>
      </div>
      
      <!-- ã‚­ãƒ£ã‚¹ãƒˆåè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="change-cast-info">
        <span class="change-cast-label">ã‚­ãƒ£ã‚¹ãƒˆ:</span>
        <span id="changeCastName" class="change-cast-name">æœªé¸æŠ</span>
      </div>
      
      <form id="changeForm" onsubmit="submitChange(event)">
        <input type="hidden" id="changeRecordId" name="record_id">
        
        <div class="change-form-group">
          <label for="changeReceivedAmount">é ã‹ã‚Šé‡‘:</label>
          <input type="number" id="changeReceivedAmount" name="received_amount" required placeholder="15000">
        </div>
        
        <div class="change-form-group">
          <label for="changeAmount">ãŠé‡£ã‚Š:</label>
          <input type="number" id="changeAmount" name="change_amount" required placeholder="3000">
        </div>
        
        <div class="change-form-group">
          <label for="changePaymentMethod">æ–¹æ³•:</label>
          <select id="changePaymentMethod" name="payment_method" required>
            <option value="ç¾é‡‘">ç¾é‡‘</option>
            <option value="ã‚«ãƒ¼ãƒ‰">ã‚«ãƒ¼ãƒ‰</option>
            <option value="å¾Œæ‰•ã„">å¾Œæ‰•ã„</option>
          </select>
        </div>
        
        <div class="change-form-buttons">
          <button type="button" class="change-cancel-btn" onclick="closeChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="change-submit-btn">ç™»éŒ²</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="calendarModal" class="calendar-modal">
    <div class="calendar-modal-content">
      <div class="calendar-modal-header">
        <h3>æ—¥ä»˜ã‚’é¸æŠ</h3>
        <span class="calendar-modal-close" onclick="closeCalendarModal()">&times;</span>
      </div>
      
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">â—€</button>
          <h4 id="calendarMonthYear">2024å¹´9æœˆ</h4>
          <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">â–¶</button>
        </div>
        
        <div class="calendar-grid">
          <div class="calendar-weekdays">
            <div class="calendar-weekday">æ—¥</div>
            <div class="calendar-weekday">æœˆ</div>
            <div class="calendar-weekday">ç«</div>
            <div class="calendar-weekday">æ°´</div>
            <div class="calendar-weekday">æœ¨</div>
            <div class="calendar-weekday">é‡‘</div>
            <div class="calendar-weekday">åœŸ</div>
          </div>
          <div class="calendar-days" id="calendarDays">
            <!-- æ—¥ä»˜ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// URLã‚’è¨­å®šï¼ˆJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ï¼‰
window.dashboardUrls = {
  store: "/{{ store }}"
};

// ç¾åœ¨ã®æ—¥ä»˜æƒ…å ±ã‚’JavaScriptã§åˆ©ç”¨
window.currentDate = "{{ current_date }}";
</script>
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>

{% endblock %}