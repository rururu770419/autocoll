{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/point_settings.css') }}">
<script src="{{ url_for('static', filename='js/point_settings.js') }}" defer></script>
{% endblock %}

{% block title %}ãƒã‚¤ãƒ³ãƒˆè¨­å®š | {{ display_name }}{% endblock %}

{% block content %}
<div class="point-settings-container">
    <h1 class="point-settings-title">ãƒã‚¤ãƒ³ãƒˆè¨­å®š</h1>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="messageArea"></div>

    <!-- äº‹å‰è¨­å®šã®æ³¨æ„æ›¸ã -->
    <div class="point-settings-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>âš ï¸ äº‹å‰è¨­å®šãŒå¿…è¦ã§ã™</strong><br>
            ã‚³ãƒ¼ã‚¹è¨­å®šï¼ˆ<a href="{{ url_for('main_routes.course_registration', store=store) }}">ã‚³ãƒ¼ã‚¹ç®¡ç†</a>ï¼‰ã¨ä¼šå“¡ç¨®åˆ¥è¨­å®šï¼ˆ<a href="/{{ store }}/settings">é¡§å®¢æƒ…å ±è¨­å®š</a>ï¼‰ã‚’å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </div>
    </div>

    <!-- ========================================
         åŸºæœ¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
         ======================================== -->
    <h2 class="point-settings-section-title">åŸºæœ¬è¨­å®š</h2>
    <div class="point-settings-form-card">
        <div class="point-settings-form-group">
            <label class="point-settings-form-label">æ–°è¦é¡§å®¢ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¤ãƒ³ãƒˆ</label>
            <div class="point-settings-input-with-unit">
                <input type="number"
                       id="new_customer_default_points"
                       class="point-settings-form-input"
                       value="{{ settings.new_customer_default_points }}"
                       min="0"
                       step="1"
                       placeholder="0">
                <span class="point-settings-unit">PT</span>
            </div>
            <small class="point-settings-form-hint">æ–°ã—ãé¡§å®¢ã‚’ç™»éŒ²ã—ãŸéš›ã«è‡ªå‹•ã§ä»˜ä¸ã•ã‚Œã¾ã™</small>
        </div>

        <div class="point-settings-form-buttons">
            <button type="button" class="point-settings-btn-submit" onclick="saveBasicSettings()">
                <i class="fas fa-save"></i> ä¿å­˜
            </button>
        </div>
    </div>

    <!-- ========================================
         é¡§å®¢æƒ…å ±ã§ã®ãƒã‚¤ãƒ³ãƒˆæ“ä½œç†ç”±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
         ======================================== -->
    <h2 class="point-settings-section-title">é¡§å®¢æƒ…å ±ã§ã®ãƒã‚¤ãƒ³ãƒˆæ“ä½œç†ç”±</h2>

    <div class="point-settings-two-column-layout">
        <!-- å·¦ï¼šç†ç”±ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆ40%ï¼‰ -->
        <div class="point-settings-form-card">
            <form id="reasonForm" onsubmit="submitReasonForm(event); return false;">
                <div class="point-settings-form-group">
                    <label class="point-settings-form-label">ç†ç”±å <span class="point-settings-required">*</span></label>
                    <input type="text"
                           id="reason_name"
                           name="reason_name"
                           class="point-settings-form-input"
                           placeholder="ä¾‹ï¼šæ–°è¦ç™»éŒ²ç‰¹å…¸"
                           required>
                    <div id="reason-edit-message" class="point-settings-edit-message" style="display: none;">
                        ğŸ’¡ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå†…å®¹ã‚’å¤‰æ›´ã—ã¦æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                    </div>
                </div>

                <div class="point-settings-form-group">
                    <label class="point-settings-form-label">çŠ¶æ…‹</label>
                    <div class="point-settings-toggle-wrapper">
                        <span class="point-settings-toggle-label">ç„¡åŠ¹</span>
                        <label class="point-settings-toggle-switch">
                            <input type="checkbox"
                                   id="reason_is_active"
                                   name="reason_is_active"
                                   class="point-settings-toggle-checkbox"
                                   checked>
                            <span class="point-settings-toggle-slider"></span>
                        </label>
                        <span class="point-settings-toggle-label">æœ‰åŠ¹</span>
                    </div>
                </div>

                <div class="point-settings-form-buttons">
                    <button type="button"
                            onclick="resetReasonForm()"
                            class="point-settings-btn-reset">
                        ãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <button type="submit" class="point-settings-btn-submit" id="reason-submit-btn">
                        ç™»éŒ²
                    </button>
                </div>
            </form>
        </div>

        <!-- å³ï¼šç†ç”±ä¸€è¦§ï¼ˆ60%ï¼‰ -->
        <div class="point-settings-list-card">
            <table class="point-settings-table">
                <thead>
                    <tr>
                        <th class="point-settings-th-sort">ä¸¦ã³é †</th>
                        <th class="point-settings-th-name">ç†ç”±å</th>
                        <th class="point-settings-th-status">çŠ¶æ…‹</th>
                        <th class="point-settings-th-edit">ç·¨é›†</th>
                        <th class="point-settings-th-delete">å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody>
                    {% if point_reasons %}
                        {% for reason in point_reasons %}
                        <tr>
                            <td class="point-settings-td-center">
                                <a href="{{ url_for('main_routes.move_point_reason_up', store=store, reason_id=reason['reason_id']) }}" class="point-settings-sort-btn {% if loop.first %}point-settings-sort-btn-disabled{% endif %}" {% if loop.first %}onclick="return false;"{% endif %} title="ä¸Šã«ç§»å‹•"><i class="fas fa-chevron-up"></i></a><a href="{{ url_for('main_routes.move_point_reason_down', store=store, reason_id=reason['reason_id']) }}" class="point-settings-sort-btn {% if loop.last %}point-settings-sort-btn-disabled{% endif %}" {% if loop.last %}onclick="return false;"{% endif %} title="ä¸‹ã«ç§»å‹•"><i class="fas fa-chevron-down"></i></a>
                            </td>
                            <td class="point-settings-td-center">{{ reason['reason_name'] }}</td>
                            <td class="point-settings-td-center">
                                {% if reason['is_active'] %}
                                    <span class="point-settings-status-active">æœ‰åŠ¹</span>
                                {% else %}
                                    <span class="point-settings-status-inactive">ç„¡åŠ¹</span>
                                {% endif %}
                            </td>
                            <td class="point-settings-td-center">
                                <button onclick="editReason({{ reason['reason_id'] }}, '{{ reason['reason_name'] }}', {{ 'true' if reason['is_active'] else 'false' }})"
                                        class="point-settings-action-btn">
                                    <i class="fas fa-pencil-alt point-settings-edit-icon"></i>
                                </button>
                            </td>
                            <td class="point-settings-td-center">
                                <button onclick="deleteReason({{ reason['reason_id'] }}, '{{ reason['reason_name'] }}')"
                                        class="point-settings-action-btn">
                                    <i class="fas fa-trash-alt point-settings-delete-icon"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="point-settings-td-empty">
                                ç†ç”±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="point-settings-table-note">
                ğŸ’¡ ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å·¦å´ãŒç·¨é›†ç”»é¢ã«ãªã‚Šã¾ã™
            </div>
        </div>
    </div>

    <!-- ========================================
         äºˆç´„æ™‚ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³
         ======================================== -->
    <h2 class="point-settings-section-title">äºˆç´„æ™‚ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸è¨­å®š</h2>
    <div class="point-settings-form-card">
        <div class="point-settings-radio-group">
            <label class="point-settings-radio-label">
                <input type="radio"
                       name="point_method"
                       value="percentage"
                       {% if settings.point_method == 'percentage' %}checked{% endif %}
                       onchange="togglePointMethod()">
                <span>æ–™é‡‘ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸æ–¹å¼</span>
            </label>
            <label class="point-settings-radio-label">
                <input type="radio"
                       name="point_method"
                       value="course_based"
                       {% if settings.point_method == 'course_based' %}checked{% endif %}
                       onchange="togglePointMethod()">
                <span>ã‚³ãƒ¼ã‚¹ãƒ»ä¼šå“¡ç¨®åˆ¥å›ºå®šãƒã‚¤ãƒ³ãƒˆæ–¹å¼</span>
            </label>
        </div>

        <div class="point-settings-form-buttons">
            <button type="button" class="point-settings-btn-submit" onclick="savePointMethod()">
                <i class="fas fa-save"></i> ä¿å­˜
            </button>
        </div>
    </div>

    <!-- ========================================
         ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸æ–¹å¼è¨­å®šã‚¨ãƒªã‚¢
         ======================================== -->
    <div id="percentageSettingsArea" class="point-settings-method-area" style="display: {% if settings.point_method == 'percentage' %}block{% else %}none{% endif %};">
        <h2 class="point-settings-section-title">ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨­å®š</h2>

        {% if not courses or not member_types %}
        <div class="point-settings-alert point-settings-alert-warning">
            <i class="fas fa-info-circle"></i> ã‚³ãƒ¼ã‚¹ã¾ãŸã¯ä¼šå“¡ç¨®åˆ¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒã‚¹ã‚¿è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        </div>
        {% else %}
        <div class="point-settings-form-card">
            <!-- ä¸€æ‹¬è¨­å®š -->
            <div class="point-settings-bulk-setting">
                <label class="point-settings-form-label">ä¸€æ‹¬è¨­å®š</label>
                <div class="point-settings-bulk-input-group">
                    <span>å…¨ã‚³ãƒ¼ã‚¹ãƒ»å…¨ä¼šå“¡ç¨®åˆ¥:</span>
                    <input type="number"
                           id="bulkPercentage"
                           class="point-settings-bulk-input"
                           min="0"
                           max="100"
                           step="1"
                           placeholder="5">
                    <span class="point-settings-unit">%</span>
                    <button type="button" class="point-settings-btn-secondary" onclick="applyBulkPercentage()">
                        <i class="fas fa-copy"></i> ä¸€æ‹¬é©ç”¨
                    </button>
                </div>
            </div>

            <!-- ãƒãƒˆãƒªãƒƒã‚¯ã‚¹è¡¨ -->
            <div class="point-settings-table-wrapper">
                <table class="point-settings-matrix-table">
                    <thead>
                        <tr>
                            <th class="point-settings-matrix-header-corner">ã‚³ãƒ¼ã‚¹ \ ä¼šå“¡ç¨®åˆ¥</th>
                            {% for member_type in member_types %}
                            <th class="point-settings-matrix-header">{{ member_type }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in courses %}
                        <tr>
                            <td class="point-settings-matrix-course-name">
                                {{ course.course_name }}
                                {% if course.category_name %}
                                <span class="point-settings-course-category">({{ course.category_name }})</span>
                                {% endif %}
                            </td>
                            {% for member_type in member_types %}
                            {% set key = course.course_id|string + '_' + member_type %}
                            <td class="point-settings-matrix-cell">
                                <input type="number"
                                       class="point-settings-matrix-input percentage-input"
                                       data-course-id="{{ course.course_id }}"
                                       data-member-type="{{ member_type }}"
                                       value="{{ percentage_dict.get(key, '') }}"
                                       min="0"
                                       max="100"
                                       step="1"
                                       placeholder="%">
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="point-settings-form-buttons">
                <button type="button" class="point-settings-btn-submit" onclick="savePercentageSettings()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ========================================
         å›ºå®šãƒã‚¤ãƒ³ãƒˆæ–¹å¼è¨­å®šã‚¨ãƒªã‚¢
         ======================================== -->
    <div id="fixedPointSettingsArea" class="point-settings-method-area" style="display: {% if settings.point_method == 'course_based' %}block{% else %}none{% endif %};">
        <h2 class="point-settings-section-title">å›ºå®šãƒã‚¤ãƒ³ãƒˆè¨­å®š</h2>

        {% if not courses or not member_types %}
        <div class="point-settings-alert point-settings-alert-warning">
            <i class="fas fa-info-circle"></i> ã‚³ãƒ¼ã‚¹ã¾ãŸã¯ä¼šå“¡ç¨®åˆ¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒã‚¹ã‚¿è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        </div>
        {% else %}
        <div class="point-settings-form-card">
            <!-- ä¸€æ‹¬è¨­å®š -->
            <div class="point-settings-bulk-setting">
                <label class="point-settings-form-label">ä¸€æ‹¬è¨­å®š</label>
                <div class="point-settings-bulk-input-group">
                    <span>å…¨ã‚³ãƒ¼ã‚¹ãƒ»å…¨ä¼šå“¡ç¨®åˆ¥:</span>
                    <input type="number"
                           id="bulkFixedPoint"
                           class="point-settings-bulk-input"
                           min="0"
                           step="1"
                           placeholder="100">
                    <span class="point-settings-unit">PT</span>
                    <button type="button" class="point-settings-btn-secondary" onclick="applyBulkFixedPoint()">
                        <i class="fas fa-copy"></i> ä¸€æ‹¬é©ç”¨
                    </button>
                </div>
            </div>

            <!-- ãƒãƒˆãƒªãƒƒã‚¯ã‚¹è¡¨ -->
            <div class="point-settings-table-wrapper">
                <table class="point-settings-matrix-table">
                    <thead>
                        <tr>
                            <th class="point-settings-matrix-header-corner">ã‚³ãƒ¼ã‚¹ \ ä¼šå“¡ç¨®åˆ¥</th>
                            {% for member_type in member_types %}
                            <th class="point-settings-matrix-header">{{ member_type }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for course in courses %}
                        <tr>
                            <td class="point-settings-matrix-course-name">
                                {{ course.course_name }}
                                {% if course.category_name %}
                                <span class="point-settings-course-category">({{ course.category_name }})</span>
                                {% endif %}
                            </td>
                            {% for member_type in member_types %}
                            {% set key = course.course_id|string + '_' + member_type %}
                            <td class="point-settings-matrix-cell">
                                <input type="number"
                                       class="point-settings-matrix-input fixed-point-input"
                                       data-course-id="{{ course.course_id }}"
                                       data-member-type="{{ member_type }}"
                                       value="{{ point_dict.get(key, '') }}"
                                       min="0"
                                       step="1"
                                       placeholder="PT">
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="point-settings-form-buttons">
                <button type="button" class="point-settings-btn-submit" onclick="saveFixedPointSettings()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
        {% if success %}
            showMessage('{{ success }}', 'success');
        {% elif error %}
            showMessage('{{ error }}', 'error');
        {% endif %}
    });
</script>
{% endblock %}
