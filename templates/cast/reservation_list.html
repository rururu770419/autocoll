{% extends "cast/cast_base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cast_reservation.css') }}">
{% endblock %}

{% block title %}予約一覧 - キャストマイページ{% endblock %}

{% block header_title %}
<i class="fas fa-calendar-check"></i>
予約一覧
{% endblock %}

{% block content %}
<div class="cr-reservation-container">
<!-- 日付ナビゲーション -->
<div class="cr-date-nav">
    <button class="cr-nav-btn" id="prevDayBtn" onclick="changeDate(-1)">
        <i class="fas fa-chevron-left"></i>
    </button>

    <button class="cr-calendar-btn" id="calendarBtn" onclick="openCalendarModal()">
        <i class="far fa-calendar-alt"></i>
    </button>

    <button class="cr-today-btn" id="todayBtn" onclick="goToToday()">
        本日
    </button>

    <div class="cr-date-display" id="dateDisplay">
        <span class="cr-date-text">
            {{ selected_date.month }}/{{ selected_date.day }}
            ({{ ['月', '火', '水', '木', '金', '土', '日'][selected_date.weekday()] }})
        </span>
    </div>

    <button class="cr-nav-btn" id="nextDayBtn" onclick="changeDate(1)">
        <i class="fas fa-chevron-right"></i>
    </button>
</div>

<!-- 予約一覧 -->
<div class="cr-reservation-list">
    {% if reservations %}
        {% for reservation in reservations %}
        <div class="cr-reservation-card" data-reservation-id="{{ reservation.reservation_id }}">
            <!-- 詳細リンク（右上） -->
            <a href="#" class="cr-detail-link-top" onclick="toggleDetail({{ reservation.reservation_id }}); return false;">詳細▼</a>

            <!-- 時間帯 -->
            <div class="cr-time">
                <i class="far fa-clock"></i>
                <span>
                {% if reservation.reservation_datetime and reservation.end_datetime %}
                    {{ reservation.reservation_datetime.strftime('%H:%M') }}～{{ reservation.end_datetime.strftime('%H:%M') }}
                {% elif reservation.reservation_datetime %}
                    {{ reservation.reservation_datetime.strftime('%H:%M') }}
                {% else %}
                    時間未設定
                {% endif %}
                </span>
            </div>

            <!-- 詳細エリア（アコーディオン） -->
            <div class="cr-accordion-detail" id="detail-{{ reservation.reservation_id }}" style="display: none;">
                <div class="cr-accordion-content">
                    <!-- 基本情報 -->
                    <div class="cr-accordion-section">
                        <h3>基本情報</h3>
                        <div class="cr-accordion-item">
                            <span class="cr-accordion-label-badge">お客様名</span>
                            <span class="cr-accordion-value">{{ reservation.customer_name or '名前なし' }}様</span>
                        </div>
                        {% if reservation.nomination_type_name %}
                        <div class="cr-accordion-item">
                            <span class="cr-accordion-label-badge">指名</span>
                            <span class="cr-accordion-value">{{ reservation.nomination_type_name }}/¥{{ '{:,}'.format(reservation.nomination_fee) if reservation.nomination_fee else '0' }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- コース内容 -->
                    <div class="cr-accordion-section">
                        <h3>コース内容</h3>
                        {% if reservation.course_name %}
                        <div class="cr-accordion-item">
                            <span class="cr-accordion-label-badge">コース</span>
                            <span class="cr-accordion-value">{{ reservation.course_name }}/¥{{ '{:,}'.format(reservation.course_price) if reservation.course_price else '0' }}</span>
                        </div>
                        {% endif %}
                        {% if reservation.discounts %}
                        <div class="cr-accordion-item cr-accordion-item-vertical">
                            <span class="cr-accordion-label-badge">割引</span>
                            <span class="cr-accordion-value">
                                {% for discount in reservation.discounts %}
                                {{ discount.name or '割引' }}/¥{{ '{:,}'.format(discount.discount_value|int) if discount.discount_value else '0' }}{% if not loop.last %}<br>{% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        {% if reservation.options %}
                        <div class="cr-accordion-item cr-accordion-item-vertical">
                            <span class="cr-accordion-label-badge">オプション</span>
                            <span class="cr-accordion-value">
                                {% for option in reservation.options %}
                                {{ option.name }}/¥{{ '{:,}'.format(option.price) if option.price else '0' }}{% if not loop.last %}<br>{% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 場所・移動 -->
                    {% if reservation.hotel_name %}
                    <div class="cr-accordion-section">
                        <h3>場所・移動</h3>
                        <div class="cr-accordion-item">
                            <span class="cr-accordion-label-badge">ホテル</span>
                            <span class="cr-accordion-value">{{ reservation.hotel_name }}/¥{{ '{:,}'.format(reservation.transportation_fee) if reservation.transportation_fee else '0' }}{% if reservation.room_number %}　{{ reservation.room_number }}号室{% endif %}</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- コメント -->
                    {% if reservation.customer_comment or reservation.staff_memo %}
                    <div class="cr-accordion-section">
                        <h3>コメント</h3>
                        {% if reservation.customer_comment %}
                        <div class="cr-accordion-comment">{{ reservation.customer_comment }}</div>
                        {% endif %}
                        {% if reservation.staff_memo %}
                        <div class="cr-accordion-comment">{{ reservation.staff_memo }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- 料金・支払い -->
                    <div class="cr-accordion-section">
                        <h3>料金・支払い</h3>
                        <div class="cr-accordion-item">
                            <span class="cr-accordion-label-badge">合計金額</span>
                            <span class="cr-accordion-value">{% if reservation.payment_method and reservation.payment_method.lower() == 'card' %}カード{% else %}現金{% endif %}/¥{{ '{:,}'.format(reservation.total_amount) if reservation.total_amount else '0' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 顧客情報 -->
            <div class="cr-customer-info">
                <div class="cr-info-row">
                    <i class="fas fa-user"></i>
                    <span class="cr-customer-name">{{ reservation.customer_name or '名前なし' }}様</span>
                    <a href="/{{ store }}/cast/customer_info?customer_id={{ reservation.customer_id }}" class="cr-info-badge">情報</a>
                </div>
                {% if reservation.nomination_type_name %}
                <div class="cr-nomination-row">
                    {% if '本指名' in reservation.nomination_type_name %}
                    <i class="fas fa-crown"></i>
                    {% elif '場内指名' in reservation.nomination_type_name %}
                    <i class="fas fa-star"></i>
                    {% else %}
                    <i class="fas fa-hand-point-right"></i>
                    {% endif %}
                    <span class="cr-nomination-type">{{ reservation.nomination_type_name|replace('指名 ', '') }}</span>
                </div>
                {% endif %}
            </div>

            <!-- コース情報 -->
            {% if reservation.course_name %}
            <div class="cr-course-info">
                <i class="fas fa-tag"></i>
                <span>{{ reservation.course_name }}</span>
            </div>
            {% endif %}

            <!-- ホテル情報 -->
            {% if reservation.hotel_name %}
            <div class="cr-hotel-info">
                <i class="fas fa-hotel"></i>
                <span>{{ reservation.hotel_name }}</span>
                {% if reservation.room_number %}
                <span class="cr-room-number">{{ reservation.room_number }}号室</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- 入室ボタン -->
            <button class="cr-checkin-btn" onclick="handleCheckin({{ reservation.reservation_id }})">
                <i class="fas fa-door-open"></i>
                入室
            </button>

            <!-- 合計金額 -->
            {% if reservation.total_amount %}
            <div class="cr-total-amount">
                <i class="fas fa-yen-sign"></i>
                <span>合計　{% if reservation.payment_method and reservation.payment_method.lower() == 'card' %}カード{% else %}現金{% endif %}/¥{{ '{:,}'.format(reservation.total_amount) }}</span>
            </div>
            {% endif %}

            <!-- お釣り入力欄（現金時のみ表示） -->
            {% if use_change_feature and reservation.payment_method and reservation.payment_method.lower() == 'cash' %}
            <div class="cr-change-section">
                <div class="cr-change-row">
                    <label class="cr-change-label">お預かり:</label>
                    <input type="number"
                           class="cr-amount-received-input"
                           data-reservation-id="{{ reservation.reservation_id }}"
                           data-total-amount="{{ reservation.total_amount }}"
                           value="{{ reservation.amount_received if reservation.amount_received else '' }}"
                           placeholder="0"
                           {% if reservation.amount_received and reservation.amount_received > 0 %}disabled{% endif %}>
                    <span class="cr-change-unit">円</span>
                    <button class="cr-save-amount-btn {% if reservation.amount_received and reservation.amount_received > 0 %}cr-edit-mode{% endif %}"
                            data-reservation-id="{{ reservation.reservation_id }}">
                        {% if reservation.amount_received and reservation.amount_received > 0 %}編集をする{% else %}登録{% endif %}
                    </button>
                </div>
                <div class="cr-change-row">
                    <span class="cr-change-label">お釣り:</span>
                    <span class="cr-change-display">
                        {% if reservation.amount_received and reservation.amount_received > 0 %}
                            ¥{{ '{:,}'.format(reservation.amount_received - reservation.total_amount) }}
                        {% else %}
                            ¥0
                        {% endif %}
                    </span>
                </div>
            </div>
            {% endif %}

        </div>
        {% endfor %}
    {% else %}
        <div class="cm-empty">
            <i class="far fa-calendar-times cm-empty-icon"></i>
            <p class="cm-empty-text">この日の予約はありません</p>
        </div>
    {% endif %}
</div>

<!-- カレンダーモーダル -->
<div class="cr-modal" id="calendarModal">
    <div class="cr-modal-overlay" onclick="closeCalendarModal()"></div>
    <div class="cr-modal-content">
        <div class="cr-modal-header">
            <button class="cr-month-nav" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 class="cr-month-title" id="monthTitle">2025年3月</h2>
            <button class="cr-month-nav" onclick="changeMonth(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="cr-calendar" id="calendar">
            <!-- カレンダーはJavaScriptで生成 -->
        </div>

        <button class="cr-modal-close" onclick="closeCalendarModal()">
            閉じる
        </button>
    </div>
</div>

<script>
    // 選択中の日付を JavaScript に渡す
    const currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}');
    const store = '{{ store }}';
</script>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cast_reservation.js') }}"></script>
{% endblock %}
