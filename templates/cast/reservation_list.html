{% extends "cast/cast_base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cast_reservation.css') }}">
{% endblock %}

{% block title %}予約一覧 - キャストマイページ{% endblock %}

{% block header_title %}
<i class="fas fa-calendar-check"></i>
予約一覧
{% endblock %}

{% block content %}
<!-- 日付ナビゲーション -->
<div class="cr-date-nav">
    <button class="cr-nav-btn" id="prevDayBtn" onclick="changeDate(-1)">
        <i class="fas fa-chevron-left"></i>
    </button>

    <button class="cr-calendar-btn" id="calendarBtn" onclick="openCalendarModal()">
        <i class="far fa-calendar-alt"></i>
    </button>

    <button class="cr-today-btn" id="todayBtn" onclick="goToToday()">
        本日
    </button>

    <div class="cr-date-display" id="dateDisplay">
        <span class="cr-date-text">
            {{ selected_date.month }}/{{ selected_date.day }}
            ({{ ['月', '火', '水', '木', '金', '土', '日'][selected_date.weekday()] }})
        </span>
    </div>

    <button class="cr-nav-btn" id="nextDayBtn" onclick="changeDate(1)">
        <i class="fas fa-chevron-right"></i>
    </button>
</div>

<!-- 予約一覧 -->
<div class="cr-reservation-list">
    {% if reservations %}
        {% for reservation in reservations %}
        <div class="cr-reservation-card">
            <!-- 詳細リンク（右上） -->
            <a href="#" class="cr-detail-link-top" onclick="openDetailModal({{ reservation.reservation_id }}); return false;">詳細</a>

            <!-- 時間帯 -->
            <div class="cr-time">
                <i class="far fa-clock"></i>
                <span>
                {% if reservation.reservation_datetime and reservation.end_datetime %}
                    {{ reservation.reservation_datetime.strftime('%H:%M') }}～{{ reservation.end_datetime.strftime('%H:%M') }}
                {% elif reservation.reservation_datetime %}
                    {{ reservation.reservation_datetime.strftime('%H:%M') }}
                {% else %}
                    時間未設定
                {% endif %}
                </span>
            </div>

            <!-- 顧客情報 -->
            <div class="cr-customer-info">
                <div class="cr-info-row">
                    <i class="fas fa-user"></i>
                    <span class="cr-customer-name">{{ reservation.customer_name or '名前なし' }}様</span>
                    <a href="/{{ store }}/cast/customer_info?customer_id={{ reservation.customer_id }}" class="cr-info-badge">情報</a>
                </div>
                {% if reservation.nomination_type_name %}
                <div class="cr-nomination-row">
                    {% if '本指名' in reservation.nomination_type_name %}
                    <i class="fas fa-crown"></i>
                    {% elif '場内指名' in reservation.nomination_type_name %}
                    <i class="fas fa-star"></i>
                    {% else %}
                    <i class="fas fa-hand-point-right"></i>
                    {% endif %}
                    <span class="cr-nomination-type">{{ reservation.nomination_type_name|replace('指名 ', '') }}</span>
                </div>
                {% endif %}
            </div>

            <!-- コース情報 -->
            {% if reservation.course_name %}
            <div class="cr-course-info">
                <i class="fas fa-tag"></i>
                <span>{{ reservation.course_name }}</span>
            </div>
            {% endif %}

            <!-- ホテル情報 -->
            {% if reservation.hotel_name %}
            <div class="cr-hotel-info">
                <i class="fas fa-hotel"></i>
                <span>{{ reservation.hotel_name }}</span>
                {% if reservation.room_number %}
                <span class="cr-room-number">{{ reservation.room_number }}号室</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- 入室ボタン -->
            <button class="cr-checkin-btn" onclick="handleCheckin({{ reservation.reservation_id }})">
                <i class="fas fa-door-open"></i>
                入室
            </button>

            <!-- 合計金額 -->
            {% if reservation.total_amount %}
            <div class="cr-total-amount">
                <i class="fas fa-yen-sign"></i>
                <span>合計　{% if reservation.payment_method and reservation.payment_method.lower() == 'card' %}カード{% else %}現金{% endif %}/¥{{ '{:,}'.format(reservation.total_amount) }}</span>
            </div>
            {% endif %}

            <!-- お釣り入力欄（現金時のみ表示） -->
            {% if use_change_feature and reservation.payment_method and reservation.payment_method.lower() == 'cash' %}
            <div class="cr-change-section">
                <div class="cr-change-row">
                    <label class="cr-change-label">お預かり:</label>
                    <input type="number"
                           class="cr-amount-received-input"
                           data-reservation-id="{{ reservation.reservation_id }}"
                           data-total-amount="{{ reservation.total_amount }}"
                           value="{{ reservation.amount_received if reservation.amount_received else '' }}"
                           placeholder="0"
                           {% if reservation.amount_received and reservation.amount_received > 0 %}disabled{% endif %}>
                    <span class="cr-change-unit">円</span>
                    <button class="cr-save-amount-btn"
                            data-reservation-id="{{ reservation.reservation_id }}"
                            {% if reservation.amount_received and reservation.amount_received > 0 %}disabled{% endif %}>
                        登録
                    </button>
                </div>
                <div class="cr-change-row">
                    <span class="cr-change-label">お釣り:</span>
                    <span class="cr-change-display">¥{{ '{:,}'.format((reservation.amount_received or 0) - reservation.total_amount) }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="cm-empty">
            <i class="far fa-calendar-times cm-empty-icon"></i>
            <p class="cm-empty-text">この日の予約はありません</p>
        </div>
    {% endif %}
</div>

<!-- カレンダーモーダル -->
<div class="cr-modal" id="calendarModal">
    <div class="cr-modal-overlay" onclick="closeCalendarModal()"></div>
    <div class="cr-modal-content">
        <div class="cr-modal-header">
            <button class="cr-month-nav" onclick="changeMonth(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 class="cr-month-title" id="monthTitle">2025年3月</h2>
            <button class="cr-month-nav" onclick="changeMonth(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="cr-calendar" id="calendar">
            <!-- カレンダーはJavaScriptで生成 -->
        </div>

        <button class="cr-modal-close" onclick="closeCalendarModal()">
            閉じる
        </button>
    </div>
</div>

<!-- 予約詳細モーダル -->
<div class="cr-modal" id="detailModal">
    <div class="cr-modal-overlay" onclick="closeDetailModal()"></div>
    <div class="cr-detail-modal-content">
        <div class="cr-detail-header">
            <h2>予約詳細</h2>
            <button class="cr-modal-close-icon" onclick="closeDetailModal()">×</button>
        </div>

        <div class="cr-detail-body" id="detailBody">
            <!-- JavaScriptで動的に生成 -->
        </div>

        <button class="cr-modal-close" onclick="closeDetailModal()">閉じる</button>
    </div>
</div>

<script>
    // 選択中の日付を JavaScript に渡す
    const currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}');
    const store = '{{ store }}';
</script>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/cast_reservation.js') }}"></script>
{% endblock %}
