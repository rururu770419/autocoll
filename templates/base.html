<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ダッシュボード{% endblock %}</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Base CSS（ヘッダーとサイドバー専用） -->
    
    <link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    {% block extra_head %}{% endblock %}
</head>
<body>

    <header class="header">
        <button class="hamburger-menu">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
        </button>
        <div class="user-info">
            <i class="fas fa-user"></i>
            <span class="user-name">{{ session['user_name'] }}</span> さん
        </div>
    </header>

    <!-- メニューオーバーレイ（スマホ版のみ） -->
    <div class="nav-overlay"></div>

    <nav class="nav-menu">
        <ul>
            <li><a href="{{ url_for('main_routes.store_home', store=session['store']) }}"><i class="fas fa-chart-pie"></i>ダッシュボード</a></li>
            <li><a href="{{ url_for('main_routes.money_management', store=session['store']) }}"><i class="fas fa-coins"></i>お釣り管理</a></li>
            <li><a href="{{ url_for('main_routes.customer_management', store=session.get('store', 'nagano')) }}"><i class="fas fa-users"></i>顧客管理</a></li>
            <li><a href="{{ url_for('schedule.cast_schedule', store=session['store']) }}"><i class="fas fa-calendar-check"></i>出勤管理</a></li>
            <li><a href="{{ url_for('gantt.gantt_chart', store=session.get('store', 'nagano')) }}"><i class="fas fa-calendar-alt"></i>タイムスケジュール</a></li>
            <li><a href="{{ url_for('staff_shift.staff_shift_page', store=session['store']) }}"><i class="fas fa-user-clock"></i>スタッフシフト</a></li>
            
            {% if session['user_role'] == 'スタッフ' %}
                <li><a href="{{ url_for('main_routes.pickup_register', store=session['store']) }}" class="nav-link"><i class="fas fa-car"></i>送迎登録</a></li>
                
                <!-- 項目登録の階層メニュー -->
                <li class="nav-parent">
                    <a href="#" class="nav-parent-link">
                        <span><i class="fas fa-cog"></i>項目登録</span>
                        <span class="nav-arrow">▶</span>
                    </a>
                    <ul class="nav-submenu" id="item-register">
                        <li><a href="/{{ session['store'] }}/settings">設定</a></li>
                        <li><a href="{{ url_for('rs_main', store=session.get('store', 'nagano')) }}">予約設定</a></li>
                        <li><a href="{{ url_for('main_routes.register_staff', store=session.get('store', 'nagano')) }}">スタッフ</a></li>
                        <li><a href="{{ url_for('main_routes.cast_management', store=session.get('store', 'nagano')) }}">キャスト</a></li>
                        <li><a href="{{ url_for('main_routes.course_registration', store=session.get('store', 'nagano')) }}">コース</a></li>
                        <li><a href="{{ url_for('main_routes.options', store=session.get('store', 'nagano')) }}">オプション</a></li>
                        <li><a href="{{ url_for('main_routes.extension_management', store=session.get('store', 'nagano')) }}">延長項目</a></li>
                        <li><a href="{{ url_for('main_routes.nominate_management', store=session.get('store', 'nagano')) }}">指名</a></li>
                        <li><a href="{{ url_for('main_routes.discount_management', store=session.get('store', 'nagano')) }}">割引</a></li>
                        <li><a href="{{ url_for('main_routes.rating_items_management', store=session.get('store', 'nagano')) }}">評価項目</a></li>
                        <li><a href="{{ url_for('main_routes.register_hotel', store=session.get('store', 'nagano')) }}">ホテル</a></li>
                    </ul>
                </li>
                
            {% endif %}
            
            
            <li><a href="{{ url_for('notice_admin.list_notices', store=session['store']) }}"><i class="fas fa-bell"></i>お知らせ管理</a></li>
            <li><a href="/{{ session['store'] }}/cast/login"><i class="fas fa-sign-in-alt"></i>キャストログイン</a></li>
            <li><a href="{{ url_for('main_routes.logout', store=session['store']) }}"><i class="fas fa-sign-out-alt"></i>ログアウト</a></li>
        </ul>
    </nav>
    
    <main class="content">
        {% block content %}{% endblock %}
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    
    <!-- 共通JavaScript関数 -->
    <script>
    // 共通のフォーム送信関数
    function submitFormAction(actionData, targetUrl) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = targetUrl;
        
        Object.keys(actionData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = actionData[key];
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }

    // 編集モード切り替え関数
    function toggleEditMode(type, id, isEdit) {
        const nameElement = document.getElementById(`${type}-name-${id}`);
        const editElement = document.getElementById(`${type}-edit-${id}`);
        const editBtn = document.querySelector(`[onclick="edit${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);
        const saveBtn = document.querySelector(`[onclick="save${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);
        const cancelBtn = document.querySelector(`[onclick="cancelEdit${type.charAt(0).toUpperCase() + type.slice(1)}(${id})"]`);
        
        if (isEdit) {
            nameElement.classList.add('hidden');
            editElement.classList.remove('hidden');
            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');
        } else {
            nameElement.classList.remove('hidden');
            editElement.classList.add('hidden');
            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }
    }

    // スマホ版：タップでサブメニューを開閉
    // PC版：ホバーでサブメニューの位置を動的に調整
    document.addEventListener('DOMContentLoaded', function() {
        // スマホ判定（768px以下）
        function isMobile() {
            return window.innerWidth <= 768;
        }

        const navParent = document.querySelector('.nav-parent');
        const navParentLink = document.querySelector('.nav-parent-link');
        const navSubmenu = document.querySelector('.nav-submenu');

        // スマホ版：タップで開閉
        if (navParentLink && isMobile()) {
            navParentLink.addEventListener('click', function(e) {
                e.preventDefault();
                navParent.classList.toggle('open');
            });
        }

        // PC版：ホバーでサブメニューの位置を動的に設定
        if (navParent && navSubmenu && !isMobile()) {
            function adjustSubmenuPosition() {
                const parentRect = navParentLink.getBoundingClientRect();
                const submenuHeight = navSubmenu.offsetHeight;
                const viewportHeight = window.innerHeight;

                // デフォルトは親要素の上端に合わせる
                let topPosition = parentRect.top;

                // 画面下部にはみ出す場合
                if (topPosition + submenuHeight > viewportHeight) {
                    // 画面下部からの余裕（20px）を持たせて配置
                    topPosition = viewportHeight - submenuHeight - 20;

                    // 画面上部にもはみ出す場合（サブメニューが非常に長い場合）
                    if (topPosition < 60) { // ヘッダーの高さ（60px）を考慮
                        topPosition = 60;
                    }
                }

                navSubmenu.style.top = topPosition + 'px';
            }

            navParent.addEventListener('mouseenter', function() {
                // 表示してから高さを取得するため、少し遅延
                setTimeout(adjustSubmenuPosition, 10);
            });

            // スクロール時も位置を更新
            const navMenu = document.querySelector('.nav-menu');
            if (navMenu) {
                navMenu.addEventListener('scroll', function() {
                    if (navParent.matches(':hover')) {
                        adjustSubmenuPosition();
                    }
                });
            }

            // ウィンドウリサイズ時も位置を更新
            window.addEventListener('resize', function() {
                if (navParent.matches(':hover') && !isMobile()) {
                    adjustSubmenuPosition();
                }
            });
        }

        // 画面サイズ変更時の対応
        window.addEventListener('resize', function() {
            if (!isMobile() && navParent) {
                navParent.classList.remove('open');
                // PC版に切り替わったら位置を再設定
                if (navSubmenu) {
                    const rect = navParentLink.getBoundingClientRect();
                    navSubmenu.style.top = rect.top + 'px';
                }
            }
        });
    });

    // メニューオーバーレイ機能（スマホ版のみ）
    document.addEventListener('DOMContentLoaded', function() {
        const navOverlay = document.querySelector('.nav-overlay');
        
        // オーバーレイのクリック処理（メニューを閉じる）
        if (navOverlay) {
            navOverlay.addEventListener('click', function() {
                const navMenu = document.querySelector('.nav-menu');
                navMenu.classList.remove('active');
                navOverlay.classList.remove('active');
            });
        }
        
        // 既存のハンバーガーメニューのクリックイベントを拡張
        const hamburgerMenu = document.querySelector('.hamburger-menu');
        if (hamburgerMenu) {
            hamburgerMenu.addEventListener('click', function() {
                // script.jsの処理が実行された後にオーバーレイも制御
                setTimeout(function() {
                    const navMenu = document.querySelector('.nav-menu');
                    if (navMenu.classList.contains('active')) {
                        navOverlay.classList.add('active');
                    } else {
                        navOverlay.classList.remove('active');
                    }
                }, 10);
            });
        }
        
        // メニュー内のリンクをクリックした時もメニューを閉じる
        const navLinks = document.querySelectorAll('.nav-menu a:not(.nav-parent-link)');
        navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
                const navMenu = document.querySelector('.nav-menu');
                navMenu.classList.remove('active');
                navOverlay.classList.remove('active');
            });
        });
    });
    </script>

    {% block extra_scripts %}{% endblock %}

</body>
</html>