{% extends "base.html" %}

{% block title %}è¨­å®šç®¡ç†{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
{% endblock %}

{% block content %}
<div class="settings-container">
  
  <h1 class="settings-title">è¨­å®šç®¡ç†</h1>
  
  {% if success %}
    <div class="settings-alert settings-alert-success">{{ success }}</div>
  {% endif %}
  {% if error %}
    <div class="settings-alert settings-alert-error">{{ error }}</div>
  {% endif %}
  
  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="settings-tabs">
    <button class="settings-tab-btn active" onclick="switchTab('store_info')">åº—èˆ—æƒ…å ±</button>
    <button class="settings-tab-btn" onclick="switchTab('notification')">é€šçŸ¥è¨­å®š</button>
    <button class="settings-tab-btn" onclick="switchTab('auto_call')">ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«è¨­å®š</button>
    <button class="settings-tab-btn" onclick="switchTab('parking')">é§è»Šå ´è¨­å®š</button>
  </div>
  
  <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <form id="settingsForm">
    
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- åº—èˆ—æƒ…å ±ã‚¿ãƒ– -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div id="store_info" class="settings-tab-content active">
      <h2 class="settings-section-title">åº—èˆ—æƒ…å ±</h2>
      
      <div class="settings-form-grid">
        {% for setting in store_info %}
          <div class="settings-form-group">
            <label for="{{ setting.setting_key }}" class="settings-label">
              {{ setting.description }}
            </label>
            
            {% if setting.setting_type == 'textarea' %}
              <textarea 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input settings-textarea"
                placeholder="{{ setting.description }}">{{ setting.setting_value or '' }}</textarea>
            {% else %}
              <input 
                type="text" 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input"
                value="{{ setting.setting_value or '' }}"
                placeholder="{{ setting.description }}">
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
      <div class="settings-button-group">
        <button type="button" class="settings-btn settings-btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
    
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- é€šçŸ¥è¨­å®šã‚¿ãƒ– -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div id="notification" class="settings-tab-content">
      <h2 class="settings-section-title">é€šçŸ¥è¨­å®š</h2>
      
      <!-- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</h3>
        
        {% for setting in notification %}
          {% if setting.setting_key == 'email_notify_enabled' %}
            <div class="settings-form-group">
              <label class="settings-checkbox-label">
                <input 
                  type="checkbox" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}"
                  {% if setting.setting_value == 'true' %}checked{% endif %}>
                <span>{{ setting.description }}</span>
              </label>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'notification_email' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <input 
                type="email" 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input"
                value="{{ setting.setting_value or '' }}"
                placeholder="example@example.com">
              <small class="settings-help-text">ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®é€šçŸ¥ãŒã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å±Šãã¾ã™</small>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <div class="settings-divider"></div>
      
      <!-- LINEé€šçŸ¥ -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">ğŸ“± LINEé€šçŸ¥ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ç”¨ï¼‰</h3>
        
        {% for setting in notification %}
          {% if setting.setting_key == 'line_notify_enabled' %}
            <div class="settings-form-group">
              <label class="settings-checkbox-label">
                <input 
                  type="checkbox" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}"
                  {% if setting.setting_value == 'true' %}checked{% endif %}>
                <span>{{ setting.description }}</span>
              </label>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'line_notify_token' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <div class="settings-password-wrapper">
                <input 
                  type="password" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}" 
                  class="settings-input"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="LINE Notifyãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›">
                <button type="button" class="settings-show-btn" onclick="togglePassword('{{ setting.setting_key }}')">è¡¨ç¤º</button>
              </div>
              <small class="settings-help-text">
                <a href="https://notify-bot.line.me/ja/" target="_blank">ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—æ–¹æ³•</a>
              </small>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'line_message_template' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <textarea 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input settings-textarea"
                rows="4"
                placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">{{ setting.setting_value or '' }}</textarea>
              <small class="settings-help-text">
                ä½¿ç”¨å¯èƒ½ãªå¤‰æ•°: {name} - ã‚­ãƒ£ã‚¹ãƒˆåã€{time} - é€€å®¤æ™‚åˆ»ã€{hotel} - ãƒ›ãƒ†ãƒ«å
              </small>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <div class="settings-button-group">
        <button type="button" class="settings-btn settings-btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
    
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«è¨­å®šã‚¿ãƒ– -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div id="auto_call" class="settings-tab-content">
      <h2 class="settings-section-title">ã‚ªãƒ¼ãƒˆã‚³ãƒ¼ãƒ«è¨­å®š</h2>
      
      {% for setting in auto_call %}
        {% if setting.setting_key == 'auto_call_enabled' %}
          <div class="settings-form-group">
            <label class="settings-checkbox-label">
              <input 
                type="checkbox" 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}"
                {% if setting.setting_value == 'true' %}checked{% endif %}>
              <span>{{ setting.description }}</span>
            </label>
          </div>
          <div class="settings-divider"></div>
        {% endif %}
      {% endfor %}
      
      <!-- Twilioæ¥ç¶šæƒ…å ± -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">ğŸ“ æ¥ç¶šæƒ…å ±</h3>
        
        {% for setting in auto_call %}
          {% if setting.setting_key in ['twilio_account_sid', 'twilio_auth_token'] %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <div class="settings-password-wrapper">
                <input 
                  type="password" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}" 
                  class="settings-input"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="{{ setting.description }}">
                <button type="button" class="settings-show-btn" onclick="togglePassword('{{ setting.setting_key }}')">è¡¨ç¤º</button>
              </div>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'twilio_phone_number' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <input 
                type="text" 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input"
                value="{{ setting.setting_value or '' }}"
                placeholder="+1 (815) 686-1213">
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <div class="settings-divider"></div>
      
      <!-- é€šè©±è¨­å®š -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">âš™ï¸ é€šè©±è¨­å®š</h3>
        
        {% for setting in auto_call %}
          {% if setting.setting_key == 'default_reminder_minutes' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <div class="settings-input-with-unit">
                <input 
                  type="number" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}" 
                  class="settings-input settings-input-number"
                  value="{{ setting.setting_value or '15' }}"
                  min="1"
                  max="60">
                <span class="settings-unit">åˆ†å‰</span>
              </div>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'call_timeout_seconds' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <div class="settings-input-with-unit">
                <input 
                  type="number" 
                  id="{{ setting.setting_key }}" 
                  name="{{ setting.setting_key }}" 
                  class="settings-input settings-input-number"
                  value="{{ setting.setting_value or '15' }}"
                  min="5"
                  max="60">
                <span class="settings-unit">ç§’ï¼ˆç´„3ã‚³ãƒ¼ãƒ«ï¼‰</span>
              </div>
            </div>
          {% endif %}
          
          {% if setting.setting_key == 'call_message_template' %}
            <div class="settings-form-group">
              <label for="{{ setting.setting_key }}" class="settings-label">
                {{ setting.description }}
              </label>
              <textarea 
                id="{{ setting.setting_key }}" 
                name="{{ setting.setting_key }}" 
                class="settings-input settings-textarea"
                rows="3"
                placeholder="éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">{{ setting.setting_value or '' }}</textarea>
              <small class="settings-help-text">
                ä½¿ç”¨å¯èƒ½ãªå¤‰æ•°: {name} - ã‚­ãƒ£ã‚¹ãƒˆå
              </small>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <div class="settings-divider"></div>
      
      <!-- ãƒ†ã‚¹ãƒˆç™ºä¿¡ -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">ğŸ§ª ãƒ†ã‚¹ãƒˆç™ºä¿¡</h3>
        
        <div class="settings-form-group">
          <label for="test_phone_number" class="settings-label">ãƒ†ã‚¹ãƒˆç”¨é›»è©±ç•ªå·</label>
          <input 
            type="tel" 
            id="test_phone_number" 
            class="settings-input"
            placeholder="090-1234-5678">
          <small class="settings-help-text">
            ç™ºä¿¡å…ƒç•ªå· {{ auto_call[3].setting_value if auto_call|length > 3 else '+18156861213' }} ã‹ã‚‰ãƒ†ã‚¹ãƒˆç™ºä¿¡ã—ã¾ã™
          </small>
        </div>
        
        <button type="button" class="settings-btn settings-btn-secondary" onclick="testCall()">
          ğŸ“ ãƒ†ã‚¹ãƒˆç™ºä¿¡ã™ã‚‹
        </button>
        
        <div id="testCallResult" class="settings-test-result"></div>
      </div>
      
      <div class="settings-divider"></div>
      
      <div class="settings-button-group">
        <button type="button" class="settings-btn settings-btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
    
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- é§è»Šå ´è¨­å®šã‚¿ãƒ– -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div id="parking" class="settings-tab-content">
      <h2 class="settings-section-title">é§è»Šå ´è¨­å®š</h2>
      
      <!-- é§è»Šå ´æ©Ÿèƒ½ON/OFF -->
      <div class="settings-form-group">
        <label class="settings-checkbox-label">
          <input 
            type="checkbox" 
            id="parking_enabled" 
            name="parking_enabled"
            onchange="toggleParkingFeature(this.checked)">
          <span>é§è»Šå ´ç®¡ç†æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
        </label>
      </div>
      
      <div class="settings-divider"></div>
      
      <!-- é§è»Šå ´ä¸€è¦§ -->
      <div id="parkingListSection" style="display: none;">
        <div class="settings-subsection">
          <h3 class="settings-subsection-title">ğŸ…¿ï¸ ç™»éŒ²æ¸ˆã¿é§è»Šå ´</h3>
          
          <div id="parkingList" class="parking-list">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </div>
          
          <button type="button" class="settings-btn settings-btn-secondary" onclick="showAddParkingModal()">
            â• é§è»Šå ´ã‚’è¿½åŠ 
          </button>
        </div>
      </div>
    </div>
    
  </form>
  
  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="saveMessage" class="settings-message"></div>
  
</div>

<!-- é§è»Šå ´è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="parkingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="parkingModalTitle">é§è»Šå ´ã‚’è¿½åŠ </h3>
      <span class="modal-close" onclick="closeParkingModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="settings-form-group">
        <label for="parkingNameInput" class="settings-label">é§è»Šå ´å</label>
        <input 
          type="text" 
          id="parkingNameInput" 
          class="settings-input"
          placeholder="ä¾‹: P1, é§…å‰ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°"
          maxlength="50">
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeParkingModal()">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveParkingLot()">
        ä¿å­˜
      </button>
    </div>
  </div>
</div>

<script>
// URLã‚’è¨­å®š
window.settingsUrls = {
  store: "/{{ store }}",
  save: "/{{ store }}/settings/save",
  testCall: "/{{ store }}/settings/test_call"
};
</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>

{% endblock %}