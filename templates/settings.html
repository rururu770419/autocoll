{% extends "base.html" %}

{% block title %}設定管理{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
<script src="{{ url_for('static', filename='js/settings.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="settings-container">

  <h1 class="settings-title">設定管理</h1>

  {% if success %}
<div class="settings-flash settings-flash-success">
    {{ success }}
    <button type="button" class="settings-flash-close">&times;</button>
</div>
{% endif %}

{% if error %}
<div class="settings-flash settings-flash-error">
    {{ error }}
    <button type="button" class="settings-flash-close">&times;</button>
</div>
{% endif %}
  
  <!-- タブナビゲーション -->
  <div class="settings-tabs">
    <button class="settings-tab-btn active" onclick="switchTab('notification')">通知設定</button>
    <button class="settings-tab-btn" onclick="switchTab('auto_call')">オートコール</button>
    <button class="settings-tab-btn" onclick="switchTab('parking')">駐車場</button>
    <button class="settings-tab-btn" onclick="switchTab('shift_types')">シフト種別</button>
    <button id="customer-info-tab" class="settings-tab-btn" onclick="switchTab('customer_info')">顧客情報</button>
  </div>
  
  <!-- タブコンテンツ -->
  <form id="settingsForm">
    
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- 通知設定タブ -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="notification" class="settings-tab-content active">
      <!-- メール通知 -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">メール通知</h3>

        <table class="settings-info-table">
          {% for setting in notification %}
            {% if setting.setting_key == 'email_notify_enabled' %}
            <tr>
              <th>メール通知</th>
              <td>
                <div class="settings-toggle-wrapper">
                  <span class="settings-toggle-label">無効</span>
                  <label class="settings-toggle-switch">
                    <input
                      type="checkbox"
                      id="{{ setting.setting_key }}"
                      name="{{ setting.setting_key }}"
                      class="settings-toggle-checkbox"
                      {% if setting.setting_value == 'true' %}checked{% endif %}>
                    <span class="settings-toggle-slider"></span>
                  </label>
                  <span class="settings-toggle-label">有効</span>
                </div>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'notification_email' %}
            <tr>
              <th>通知先アドレス</th>
              <td>
                <input
                  type="email"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="example@example.com">
                <small class="settings-help-text">システムからの通知がこのアドレスに届きます</small>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </table>
      </div>
      
     
      
      <!-- LINE通知 -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">LINE通知設定</h3>

        <table class="settings-notification-table">
          {% for setting in notification %}
            {% if setting.setting_key == 'line_message_template' %}
            <tr>
              <th>スタッフ用メッセージテンプレート</th>
              <td>
                <textarea
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-textarea settings-textarea-full"
                  rows="4"
                  placeholder="【ピックアップリマインダー】&#10;キャスト: {name}さん&#10;退室時刻: {time}&#10;ホテル: {hotel}">{{ setting.setting_value or '' }}</textarea>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'store_line_message_template' %}
            <tr>
              <th>店舗用メッセージ<br>（オートコール結果通知）</th>
              <td>
                <textarea
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-textarea settings-textarea-full"
                  rows="5"
                  placeholder="【オートコール{result}】&#10;{name}さんへの発信{result_text}&#10;退室予定: {time}&#10;発信時刻: {call_time}">{{ setting.setting_value or '' }}</textarea>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'line_channel_access_token' %}
            <tr>
              <th>LINE Channel Access Token <span class="settings-required">*必須</span></th>
              <td>
                <input
                  type="text"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input settings-input-full"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="Channel Access Tokenを入力してください">
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'line_channel_secret' %}
            <tr>
              <th>LINE Channel Secret</th>
              <td>
                <input
                  type="text"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input settings-input-full"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="Channel Secretを入力してください">
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'line_bot_id' %}
            <tr>
              <th>LINE Bot ID</th>
              <td>
                <input
                  type="text"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="@から始まるBot ID（例: @275gmabd）">
                <small class="settings-help-text">
                  スタッフがQRコードから友だち追加するBot IDを設定してください。<br>
                  LINE Official Account Manager → 設定 → アカウント設定 → ベーシックID で確認できます。
                </small>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'store_line_id' %}
            <tr>
              <th>店舗用LINE ID</th>
              <td>
                <input
                  type="text"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="Uから始まるLINE IDを入力">
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'line_notify_enabled' %}
            <tr>
              <th>LINE通知</th>
              <td>
                <div class="settings-toggle-wrapper">
                  <span class="settings-toggle-label">無効</span>
                  <label class="settings-toggle-switch">
                    <input
                      type="checkbox"
                      id="{{ setting.setting_key }}"
                      name="{{ setting.setting_key }}"
                      class="settings-toggle-checkbox"
                      {% if setting.setting_value == 'true' %}checked{% endif %}>
                    <span class="settings-toggle-slider"></span>
                  </label>
                  <span class="settings-toggle-label">有効</span>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </table>
      </div>
      
      <div class="settings-button-group">
        <button type="button" class="settings-btn settings-btn-primary" onclick="saveNotificationSettings()">保存</button>
      </div>
    </div>
    
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- オートコールタブ -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="auto_call" class="settings-tab-content">
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">オートコール</h3>

        <table class="settings-info-table">
          {% for setting in auto_call %}
            {% if setting.setting_key == 'auto_call_enabled' %}
            <tr>
              <th>オートコール</th>
              <td>
                <div class="settings-toggle-wrapper">
                  <span class="settings-toggle-label">無効</span>
                  <label class="settings-toggle-switch">
                    <input
                      type="checkbox"
                      id="{{ setting.setting_key }}"
                      name="{{ setting.setting_key }}"
                      class="settings-toggle-checkbox"
                      {% if setting.setting_value == 'true' %}checked{% endif %}>
                    <span class="settings-toggle-slider"></span>
                  </label>
                  <span class="settings-toggle-label">有効</span>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </table>
      </div>

      <!-- 接続情報 -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">接続情報</h3>

        <table class="settings-info-table">
          {% for setting in auto_call %}
            {% if setting.setting_key == 'twilio_account_sid' %}
            <tr>
              <th>Twilio Account SID</th>
              <td>
                <div class="settings-input-with-button">
                  <input
                    type="password"
                    id="{{ setting.setting_key }}"
                    name="{{ setting.setting_key }}"
                    class="settings-input settings-input-full"
                    value="{{ setting.setting_value or '' }}"
                    placeholder="Twilio Account SIDを入力してください">
                  <button type="button" class="settings-show-button" onclick="togglePassword('{{ setting.setting_key }}')">表示</button>
                </div>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'twilio_auth_token' %}
            <tr>
              <th>Twilio Auth Token</th>
              <td>
                <div class="settings-input-with-button">
                  <input
                    type="password"
                    id="{{ setting.setting_key }}"
                    name="{{ setting.setting_key }}"
                    class="settings-input settings-input-full"
                    value="{{ setting.setting_value or '' }}"
                    placeholder="Twilio Auth Tokenを入力してください">
                  <button type="button" class="settings-show-button" onclick="togglePassword('{{ setting.setting_key }}')">表示</button>
                </div>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'twilio_phone_number' %}
            <tr>
              <th>Twilio発信元電話番号</th>
              <td>
                <input
                  type="text"
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-input settings-input-full"
                  value="{{ setting.setting_value or '' }}"
                  placeholder="+1 (815) 686-1213">
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </table>
      </div>

      <!-- 通話設定 -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">通話設定</h3>

        <table class="settings-info-table">
          {% for setting in auto_call %}
            {% if setting.setting_key == 'default_reminder_minutes' %}
            <tr>
              <th>デフォルト<br>リマインダー時間</th>
              <td>
                <div class="settings-input-group">
                  <input
                    type="number"
                    id="{{ setting.setting_key }}"
                    name="{{ setting.setting_key }}"
                    class="settings-input settings-input-number"
                    value="{{ setting.setting_value or '15' }}"
                    min="1"
                    max="60">
                  <span class="settings-input-suffix">分前</span>
                </div>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'call_timeout_seconds' %}
            <tr>
              <th>通話タイムアウト</th>
              <td>
                <div class="settings-input-group">
                  <input
                    type="number"
                    id="{{ setting.setting_key }}"
                    name="{{ setting.setting_key }}"
                    class="settings-input settings-input-number"
                    value="{{ setting.setting_value or '15' }}"
                    min="5"
                    max="60">
                  <span class="settings-input-suffix">秒（約3コール）</span>
                </div>
              </td>
            </tr>
            {% endif %}

            {% if setting.setting_key == 'call_message_template' %}
            <tr>
              <th>音声メッセージ<br>テンプレート</th>
              <td>
                <textarea
                  id="{{ setting.setting_key }}"
                  name="{{ setting.setting_key }}"
                  class="settings-textarea settings-textarea-full"
                  rows="3"
                  placeholder="音声メッセージ">{{ setting.setting_value or '' }}</textarea>
                <small class="settings-help-text">
                  使用可能な変数: {name} - キャスト名
                </small>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </table>
      </div>

      <!-- テスト発信 -->
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">テスト発信</h3>

        <table class="settings-info-table">
          <tr>
            <th>テスト発信</th>
            <td>
              <div class="settings-test-call-container">
                <input
                  type="tel"
                  id="test_phone_number"
                  class="settings-input"
                  placeholder="090-1234-5678">
                <div class="settings-test-call-info">
                  <small class="settings-help-text">
                    発信元番号 {{ auto_call[3].setting_value if auto_call|length > 3 else '+18156861213' }} からテスト発信します
                  </small>
                  <button type="button" class="settings-btn settings-btn-secondary" onclick="testCall()">テスト発信する</button>
                </div>
              </div>
              <div id="testCallResult" class="settings-test-result"></div>
            </td>
          </tr>
        </table>
      </div>

      <div class="settings-button-group">
        <button type="button" class="settings-btn settings-btn-primary" onclick="saveAutoCallSettings()">保存</button>
      </div>
    </div>
    
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- 駐車場タブ -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="parking" class="settings-tab-content">
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">駐車場</h3>

        <table class="settings-info-table">
          <tr>
            <th>駐車場管理機能</th>
            <td>
              <div class="settings-toggle-wrapper">
                <span class="settings-toggle-label">無効</span>
                <label class="settings-toggle-switch">
                  <input
                    type="checkbox"
                    id="parking_enabled"
                    name="parking_enabled"
                    class="settings-toggle-checkbox"
                    {% if parking_enabled %}checked{% endif %}
                    onchange="toggleParkingFeature(this.checked)">
                  <span class="settings-toggle-slider"></span>
                </label>
                <span class="settings-toggle-label">有効</span>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- 駐車場一覧 -->
      <div id="parkingListSection" style="display: none;">
        <div class="settings-subsection">
          <h3 class="settings-subsection-title">登録済み駐車場</h3>

          <div id="parkingList" class="parking-list">
            <!-- JavaScriptで動的に生成 -->
          </div>

          <button type="button" class="settings-btn settings-btn-primary" onclick="showAddParkingModal()">
            駐車場を追加
          </button>
        </div>
      </div>
    </div>
    
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- シフト種別タブ -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="shift_types" class="settings-tab-content">
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">シフト種別</h3>
        
        <div id="shiftTypeList" class="shift-type-list">
          <!-- JavaScriptで動的に生成 -->
        </div>
        
        <button type="button" class="settings-btn settings-btn-primary" onclick="showAddShiftTypeModal()">
          シフト種別を追加
        </button>
      </div>
    </div>
    
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- 顧客情報タブ -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <div id="customer_info" class="settings-tab-content">
      <div class="settings-subsection">
        <h3 class="settings-subsection-title">顧客情報</h3>
        <p class="settings-help-text">
          顧客登録・編集で使用する選択肢を管理します。各項目に色を設定でき、顧客一覧や編集画面で色分け表示されます。
        </p>

        <div id="customerFieldsContainer" class="customer-fields-container">
          <!-- JavaScriptで動的に生成 -->
          <div class="settings-loading">読み込み中...</div>
        </div>
      </div>
    </div>
    
  </form>
  
  <!-- メッセージ表示エリア -->
  <div id="saveMessage" class="settings-message"></div>
  
</div>

<!-- 駐車場追加・編集モーダル -->
<div id="parkingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="parkingModalTitle">駐車場を追加</h3>
      <span class="modal-close" onclick="closeParkingModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="settings-form-group">
        <label for="parkingNameInput" class="settings-label">駐車場名</label>
        <input 
          type="text" 
          id="parkingNameInput" 
          class="settings-input"
          placeholder="例: P1, 駅前パーキング"
          maxlength="50">
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeParkingModal()">
        キャンセル
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveParkingLot()">
        保存
      </button>
    </div>
  </div>
</div>

<!-- シフト種別追加・編集モーダル -->
<div id="shiftTypeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="shiftTypeModalTitle">シフト種別を追加</h3>
      <span class="modal-close" onclick="closeShiftTypeModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="settings-form-group">
        <label for="shiftTypeNameInput" class="settings-label">シフト名</label>
        <input 
          type="text" 
          id="shiftTypeNameInput" 
          class="settings-input"
          placeholder="例: 早番、遅番、夜勤"
          maxlength="50">
      </div>
      
      <div class="settings-form-group">
        <label class="settings-checkbox-label">
          <input 
            type="checkbox" 
            id="shiftTypeIsWorkDay"
            checked>
          <span>出勤日として扱う（休日の場合はチェックを外す）</span>
        </label>
      </div>
      
      <div class="settings-form-group">
        <label for="shiftTypeColorInput" class="settings-label">表示色</label>
        <div class="color-picker-wrapper">
          <input 
            type="color" 
            id="shiftTypeColorInput" 
            class="color-input"
            value="#4CAF50">
          <input 
            type="text" 
            id="shiftTypeColorText" 
            class="settings-input color-text-input"
            value="#4CAF50"
            maxlength="7"
            pattern="^#[0-9A-Fa-f]{6}$">
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeShiftTypeModal()">
        キャンセル
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveShiftType()">
        保存
      </button>
    </div>
  </div>
</div>

<!-- カテゴリ名編集モーダル -->
<div id="categoryEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>カテゴリ名を変更</h3>
      <span class="modal-close" onclick="closeCategoryEditModal()">&times;</span>
    </div>

    <div class="modal-body">
      <div class="settings-form-group">
        <label for="categoryLabelInput" class="settings-label">新しい名前</label>
        <input
          type="text"
          id="categoryLabelInput"
          class="settings-input"
          placeholder="例: ランク、グレード"
          maxlength="50">
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeCategoryEditModal()">
        キャンセル
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveCategoryLabel()">
        保存
      </button>
    </div>
  </div>
</div>

<!-- 顧客情報項目編集モーダル -->
<div id="customerFieldEditModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="customerFieldEditModalTitle">項目を編集</h3>
      <span class="modal-close" onclick="closeCustomerFieldEditModal()">&times;</span>
    </div>

    <div class="modal-body">
      <div class="settings-form-group">
        <label for="customerFieldNameInput" class="settings-label">項目名</label>
        <input
          type="text"
          id="customerFieldNameInput"
          class="settings-input"
          placeholder="例: VIP会員"
          maxlength="100">
      </div>

      <div class="settings-form-group">
        <label for="customerFieldColorInput" class="settings-label">表示色</label>
        <div class="color-picker-wrapper">
          <input
            type="color"
            id="customerFieldColorInput"
            class="color-input"
            value="#f0f0f0">
          <input
            type="text"
            id="customerFieldColorText"
            class="settings-input color-text-input"
            value="#f0f0f0"
            maxlength="7"
            pattern="^#[0-9A-Fa-f]{6}$">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeCustomerFieldEditModal()">
        キャンセル
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveCustomerFieldEdit()">
        保存
      </button>
    </div>
  </div>
</div>

<!-- 選択肢追加モーダル -->
<div id="optionAddModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>項目を追加</h3>
      <span class="modal-close" onclick="closeOptionAddModal()">&times;</span>
    </div>
    
    <div class="modal-body">
      <div class="settings-form-group">
        <label for="optionValueInput" class="settings-label">項目名</label>
        <input 
          type="text" 
          id="optionValueInput" 
          class="settings-input"
          placeholder="例: VIP会員"
          maxlength="100">
      </div>
      
      <div class="settings-form-group">
        <label for="optionColorInput" class="settings-label">表示色</label>
        <div class="color-picker-group">
          <input 
            type="color" 
            id="optionColorInput" 
            class="color-input"
            value="#f0f0f0"
            onchange="updateColorPreview('optionColorInput', 'optionColorPreview')">
          <span id="optionColorPreview" class="color-preview" style="background-color: #f0f0f0;">#f0f0f0</span>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="settings-btn settings-btn-secondary" onclick="closeOptionAddModal()">
        キャンセル
      </button>
      <button type="button" class="settings-btn settings-btn-primary" onclick="saveNewOption()">
        追加
      </button>
    </div>
  </div>
</div>

<script>
// URLを設定
window.settingsUrls = {
  store: "/{{ store }}",
  save: "/{{ store }}/settings/save",
  testCall: "/{{ store }}/settings/test_call"
};
</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings_customer.js') }}"></script>

{% endblock %}